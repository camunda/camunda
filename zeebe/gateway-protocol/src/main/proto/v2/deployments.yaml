## Endpoint definitions

paths:
  /deployments:
    post:
      x-eventually-consistent: false
      tags:
        - Resource
      operationId: createDeployment
      summary: Deploy resources
      description: |
        Deploys one or more resources (e.g. processes, decision models, or forms).
        This is an atomic call, i.e. either all resources are deployed or none of them are.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              additionalProperties: false
              type: object
              properties:
                resources:
                  type: array
                  description: |
                    The binary data to create the deployment resources. It is possible to have more than one form part with different form part names for the binary data to create a deployment.
                  items:
                    type: string
                    format: binary
                tenantId:
                  $ref: 'identifiers.yaml#/components/schemas/TenantId'
              required:
                - resources
      responses:
        "200":
          description: The resources are deployed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeploymentResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "503":
          $ref: 'common-responses.yaml#/components/responses/ServiceUnavailable'

  /resources/{resourceKey}:
    get:
      x-eventually-consistent: false
      tags:
        - Resource
      operationId: getResource
      summary: Get resource
      description: |
        Returns a deployed resource.
        :::info
        Currently, this endpoint only supports RPA resources.
        :::
      parameters:
        - name: resourceKey
          in: path
          required: true
          description: The unique key identifying the resource.
          schema:
            $ref: '#/components/schemas/ResourceKey'
      responses:
        "200":
          description: The resource is successfully returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceResult'
        "404":
          description: A resource with the given key was not found.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /resources/{resourceKey}/content:
    get:
      x-eventually-consistent: false
      tags:
        - Resource
      operationId: getResourceContent
      summary: Get resource content
      description: |
        Returns the content of a deployed resource.
        :::info
        Currently, this endpoint only supports RPA resources.
        :::
      parameters:
        - name: resourceKey
          in: path
          required: true
          description: The unique key identifying the resource.
          schema:
            $ref: '#/components/schemas/ResourceKey'
      responses:
        "200":
          description: The resource content is successfully returned.
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        "404":
          description: A resource with the given key was not found.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /resources/{resourceKey}/deletion:
    post:
      x-eventually-consistent: false
      tags:
        - Resource
      operationId: deleteResource
      summary: Delete resource
      description: |-
        Deletes a deployed resource. This can be a process definition, decision requirements
        definition, or form definition deployed using the deploy resources endpoint. Specify the
        resource you want to delete in the `resourceKey` parameter.

        Once a resource has been deleted it cannot be recovered. If the resource needs to be
        available again, a new deployment of the resource is required.

        By default, only the resource itself is deleted from the runtime state. To also delete the
        historic data associated with a resource, set the `deleteHistory` flag in the request body
        to `true`. The historic data is deleted asynchronously via a batch operation. The details of
        the created batch operation are included in the response. Note that history deletion is only
        supported for process resources; for other resource types this flag is ignored and no history
        will be deleted.
      parameters:
        - name: resourceKey
          in: path
          required: true
          description: |
            The key of the resource to delete.
            This can be the key of a process definition, the key of a decision requirements
            definition or the key of a form definition
          schema:
            $ref: '#/components/schemas/ResourceKey'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteResourceRequest'
      responses:
        "200":
          description: The resource is deleted.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResourceResponse'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "404":
          description: The resource is not found.
          content:
            application/problem+json:
              schema:
                $ref: "problem-detail.yaml#/components/schemas/ProblemDetail"
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'
        "503":
          $ref: 'common-responses.yaml#/components/responses/ServiceUnavailable'

## Schema definitions

components:
  schemas:
    DeploymentResult:
      type: object
      required:
        - deploymentKey
        - tenantId
        - deployments
      properties:
        deploymentKey:
          allOf:
            - $ref: '#/components/schemas/DeploymentKey'
          description: The unique key identifying the deployment.
        tenantId:
          description: The tenant ID associated with the deployment.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
        deployments:
          description: Items deployed by the request.
          type: array
          items:
            $ref: '#/components/schemas/DeploymentMetadataResult'

    DeploymentMetadataResult:
      type: object
      properties:
        processDefinition:
          $ref: '#/components/schemas/DeploymentProcessResult'
        decisionDefinition:
          $ref: '#/components/schemas/DeploymentDecisionResult'
        decisionRequirements:
          $ref: '#/components/schemas/DeploymentDecisionRequirementsResult'
        form:
          $ref: '#/components/schemas/DeploymentFormResult'
        resource:
          $ref: '#/components/schemas/DeploymentResourceResult'

    DeploymentProcessResult:
      description: A deployed process.
      x-semantic-provider:
        - processDefinitionKey
        - processDefinitionId
      type: object
      required:
        - processDefinitionId
        - processDefinitionVersion
        - resourceName
        - processDefinitionKey
        - tenantId
      properties:
        processDefinitionId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/ProcessDefinitionId'
          description: |
            The bpmn process ID, as parsed during deployment, together with the version forms a
            unique identifier for a specific process definition.
        processDefinitionVersion:
          type: integer
          format: int32
          description: The assigned process version.
        resourceName:
          type: string
          description: The resource name from which this process was parsed.
        tenantId:
          description: The tenant ID of the deployed process.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
        processDefinitionKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
          description: The assigned key, which acts as a unique identifier for this process.

    DeploymentDecisionResult:
      description: A deployed decision.
      type: object
      x-semantic-provider:
        - decisionDefinitionKey
        - decisionRequirementsKey
      properties:
        decisionDefinitionId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/DecisionDefinitionId'
          description: |
            The dmn decision ID, as parsed during deployment, together with the version forms a
            unique identifier for a specific decision.
        version:
          type: integer
          format: int32
          description: The assigned decision version.
        name:
          type: string
          description: The DMN name of the decision, as parsed during deployment.
        tenantId:
          description: The tenant ID of the deployed decision.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
        decisionRequirementsId:
          type: string
          description: |
            The dmn ID of the decision requirements graph that this decision is part of, as parsed during deployment.
        decisionDefinitionKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/DecisionDefinitionKey'
          description: |
            The assigned decision key, which acts as a unique identifier for this decision.
        decisionRequirementsKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/DecisionRequirementsKey'
          description: |
            The assigned key of the decision requirements graph that this decision is part of.

    DeploymentDecisionRequirementsResult:
      description: Deployed decision requirements.
      type: object
      x-semantic-provider:
        - decisionRequirementsKey
      properties:
        decisionRequirementsId:
          type: string
        decisionRequirementsName:
          type: string
        version:
          type: integer
          format: int32
        resourceName:
          type: string
        tenantId:
          description: The tenant ID of the deployed decision requirements.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
        decisionRequirementsKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/DecisionRequirementsKey'
          description: |
            The assigned decision requirements key, which acts as a unique identifier for this decision requirements.

    DeploymentFormResult:
      description: A deployed form.
      type: object
      x-semantic-provider:
        - formKey
      properties:
        formId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/FormId'
          description: |
            The form ID, as parsed during deployment, together with the version forms a
            unique identifier for a specific form.
        version:
          type: integer
          format: int32
        resourceName:
          type: string
        tenantId:
          $ref: 'identifiers.yaml#/components/schemas/TenantId'
        formKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/FormKey'
          description: The assigned key, which acts as a unique identifier for this form.

    DeploymentResourceResult:
      description: A deployed Resource.
      x-semantic-provider:
        - resourceKey
      type: object
      properties:
        resourceId:
          type: string
        resourceName:
          type: string
        version:
          type: integer
          format: int32
        tenantId:
          $ref: 'identifiers.yaml#/components/schemas/TenantId'
        resourceKey:
          allOf:
            - $ref: '#/components/schemas/ResourceKey'
          description: The assigned key, which acts as a unique identifier for this Resource.

    DeleteResourceRequest:
      type: object
      nullable: true
      additionalProperties: false
      properties:
        operationReference:
          $ref: 'keys.yaml#/components/schemas/OperationReference'
        deleteHistory:
          description: |
            Indicates if the historic data of a process resource should be deleted via a
            batch operation asynchronously.

            This flag is only effective for process resources. For other resource types
            (decisions, forms, generic resources), this flag is ignored and no history
            will be deleted. In those cases, the `batchOperation` field in the response
            will not be populated.
          type: boolean
          required: false
          default: false

    DeleteResourceResponse:
      type: object
      required:
        - resourceKey
      properties:
        resourceKey:
          allOf:
            - $ref: '#/components/schemas/ResourceKey'
          description: The system-assigned key for this resource, requested to be deleted.
        batchOperation:
          allOf:
            - $ref: 'batch-operations.yaml#/components/schemas/BatchOperationCreatedResult'
          description: |
            The batch operation created for asynchronously deleting the historic data.

            This field is only populated when the request `deleteHistory` is set to `true` and the resource
            is a process definition. For other resource types (decisions, forms, generic resources),
            this field will not be present in the response.

    ResourceResult:
      type: object
      properties:
        resourceName:
          description: The resource name from which this resource was parsed.
          type: string
        version:
          description: The assigned resource version.
          type: integer
          format: int32
        versionTag:
          description: The version tag of this resource.
          type: string
        resourceId:
          description: The resource ID of this resource.
          type: string
        tenantId:
          description: The tenant ID of this resource.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
        resourceKey:
          allOf:
            - $ref: '#/components/schemas/ResourceKey'
          description: The unique key of this resource.

    ## Keys

    DeploymentKey:
      description: Key for a deployment.
      format: DeploymentKey
      x-semantic-type: DeploymentKey
      type: string
      allOf:
        - $ref: 'keys.yaml#/components/schemas/LongKey'

    ResourceKey:
      type: string
      oneOf:
        - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
        - $ref: 'keys.yaml#/components/schemas/DecisionRequirementsKey'
        - $ref: 'keys.yaml#/components/schemas/FormKey'
        - $ref: 'keys.yaml#/components/schemas/DecisionDefinitionKey'
      description: The system-assigned key for this resource.
      format: ResourceKey

    ## Filters

    DeploymentKeyFilterProperty:
      description: DeploymentKey property with full advanced search capabilities.
      type: object
      oneOf:
        - type: string
          title: Exact match
          description: Matches the value exactly.
          allOf:
            - $ref: "#/components/schemas/DeploymentKey"
        - $ref: '#/components/schemas/AdvancedDeploymentKeyFilter'

    AdvancedDeploymentKeyFilter:
      title: Advanced filter
      description: Advanced DeploymentKey filter.
      type: object
      properties:
        $eq:
          description: Checks for equality with the provided value.
          allOf:
            - $ref: '#/components/schemas/DeploymentKey'
        $neq:
          description: Checks for inequality with the provided value.
          allOf:
            - $ref: '#/components/schemas/DeploymentKey'
        $exists:
          description: Checks if the current property exists.
          type: boolean
        $in:
          description: Checks if the property matches any of the provided values.
          type: array
          items:
            $ref: '#/components/schemas/DeploymentKey'
        $notIn:
          description: Checks if the property matches none of the provided values.
          type: array
          items:
            $ref: '#/components/schemas/DeploymentKey'

    ResourceKeyFilterProperty:
      description: ResourceKey property with full advanced search capabilities.
      type: object
      oneOf:
        - type: string
          title: Exact match
          description: Matches the value exactly.
          allOf:
            - $ref: "#/components/schemas/ResourceKey"
        - $ref: "#/components/schemas/AdvancedResourceKeyFilter"

    AdvancedResourceKeyFilter:
      title: Advanced filter
      description: Advanced ResourceKey filter.
      type: object
      properties:
        $eq:
          description: Checks for equality with the provided value.
          allOf:
            - $ref: "#/components/schemas/ResourceKey"
        $neq:
          description: Checks for inequality with the provided value.
          allOf:
            - $ref: "#/components/schemas/ResourceKey"
        $exists:
          description: Checks if the current property exists.
          type: boolean
        $in:
          description: Checks if the property matches any of the provided values.
          type: array
          items:
            $ref: "#/components/schemas/ResourceKey"
        $notIn:
          description: Checks if the property matches none of the provided values.
          type: array
          items:
            $ref: "#/components/schemas/ResourceKey"
