## Endpoint definitions

paths:
  /incidents/search:
    post:
      x-eventually-consistent: true
      tags:
        - Incident
      operationId: searchIncidents
      summary: Search incidents
      description: |
        Search for incidents based on given criteria.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncidentSearchQuery'
      responses:
        "200":
          description: The incident search result.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentSearchQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /incidents/{incidentKey}:
    get:
      x-eventually-consistent: true
      tags:
        - Incident
      operationId: getIncident
      summary: Get incident
      description: |
        Returns incident as JSON.
      parameters:
        - name: incidentKey
          in: path
          required: true
          description: The assigned key of the incident, which acts as a unique identifier for this incident.
          schema:
            $ref: 'keys.yaml#/components/schemas/IncidentKey'
      responses:
        "200":
          description: The incident is successfully returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: The incident with the given key was not found.
          content:
            application/problem+json:
              schema:
                $ref: 'problem-detail.yaml#/components/schemas/ProblemDetail'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /incidents/{incidentKey}/resolution:
    post:
      x-eventually-consistent: false
      tags:
        - Incident
      operationId: resolveIncident
      summary: Resolve incident
      description: |
        Marks the incident as resolved; most likely a call to Update job will be necessary
        to reset the job's retries, followed by this call.
      parameters:
        - name: incidentKey
          in: path
          required: true
          description: Key of the incident to resolve.
          schema:
            $ref: 'keys.yaml#/components/schemas/IncidentKey'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncidentResolutionRequest'
      responses:
        "204":
          description: The incident is marked as resolved.
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "404":
          description: The incident with the incidentKey is not found.
          content:
            application/problem+json:
              schema:
                $ref: 'problem-detail.yaml#/components/schemas/ProblemDetail'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'
        "503":
          $ref: 'common-responses.yaml#/components/responses/ServiceUnavailable'

  /incidents/statistics/process-instances-by-error:
    post:
      x-eventually-consistent: true
      tags:
        - Incident
      operationId: getProcessInstanceStatisticsByError
      summary: Get statistics about active process instances grouped by incident error
      description: |
        Returns statistics for active process instances that currently have active incidents,
        grouped by incident error hash code.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByErrorQuery'
      responses:
        "200":
          description: |
            The statistics about process instances with incident, grouped by error hash code are
            successfully returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByErrorQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /incidents/statistics/process-instances-by-definition:
    post:
      x-eventually-consistent: true
      tags:
        - Incident
      operationId: getProcessInstanceStatisticsByDefinition
      summary: Get process instance statistics by definition
      description: |
        Returns statistics for active process instances with incidents, grouped by process
        definition. The result set is scoped to a specific incident error hash code, which must be
        provided as a filter in the request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByDefinitionQuery'
      responses:
        "200":
          description: |
            The process instance incident statistics grouped by process definition are successfully
            returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByDefinitionQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

## Schema definitions

components:
  schemas:
    IncidentSearchQuery:
      additionalProperties: false
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryRequest'
      properties:
        sort:
          description: Sort field criteria.
          type: array
          items:
            $ref: '#/components/schemas/IncidentSearchQuerySortRequest'
        filter:
          description: The incident search filters.
          allOf:
            - $ref: '#/components/schemas/IncidentFilter'

    IncidentFilter:
      description: Incident search filter.
      type: object
      properties:
        processDefinitionId:
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
          description: The process definition ID associated to this incident.
        errorType:
          description: Incident error type with a defined set of values.
          allOf:
            - $ref: '#/components/schemas/IncidentErrorTypeFilterProperty'
        errorMessage:
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
        elementId:
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
          description: The element ID associated to this incident.
        creationTime:
          allOf:
            - $ref: "filters.yaml#/components/schemas/DateTimeFilterProperty"
          description: Date of incident creation.
        state:
          description: State of this incident with a defined set of values.
          allOf:
            - $ref: '#/components/schemas/IncidentStateFilterProperty'
        tenantId:
          description: The tenant ID of the incident.
          allOf:
            - $ref: "filters.yaml#/components/schemas/StringFilterProperty"
        incidentKey:
          allOf:
            - $ref: 'filters.yaml#/components/schemas/BasicStringFilterProperty'
          description: The assigned key, which acts as a unique identifier for this incident.
        processDefinitionKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKeyFilterProperty'
          description: The process definition key associated to this incident.
        processInstanceKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessInstanceKeyFilterProperty'
          description: The process instance key associated to this incident.
        elementInstanceKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ElementInstanceKeyFilterProperty'
          description: The element instance key associated to this incident.
        jobKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/JobKeyFilterProperty'
          description: The job key, if exists, associated with this incident.

    IncidentErrorTypeFilterProperty:
      description: IncidentErrorTypeEnum with full advanced search capabilities.
      type: object
      oneOf:
        - type: string
          title: Exact match
          description: Matches the value exactly.
          allOf:
            - $ref: "#/components/schemas/IncidentErrorTypeEnum"
        - $ref: '#/components/schemas/AdvancedIncidentErrorTypeFilter'

    AdvancedIncidentErrorTypeFilter:
      title: Advanced filter
      description: Advanced IncidentErrorTypeEnum filter
      type: object
      properties:
        $eq:
          description: Checks for equality with the provided value.
          allOf:
            - $ref: "#/components/schemas/IncidentErrorTypeEnum"
        $neq:
          description: Checks for inequality with the provided value.
          allOf:
            - $ref: "#/components/schemas/IncidentErrorTypeEnum"
        $exists:
          description: Checks if the current property exists.
          type: boolean
        $in:
          description: Checks if the property matches any of the provided values.
          type: array
          items:
            $ref: "#/components/schemas/IncidentErrorTypeEnum"
        $notIn:
          description: Checks if the property does not match any of the provided values.
          type: array
          items:
            $ref: "#/components/schemas/IncidentErrorTypeEnum"
        $like:
          $ref: "filters.yaml#/components/schemas/LikeFilter"

    IncidentErrorTypeEnum:
      description: Incident error type with a defined set of values.
      enum:
        - AD_HOC_SUB_PROCESS_NO_RETRIES
        - CALLED_DECISION_ERROR
        - CALLED_ELEMENT_ERROR
        - CONDITION_ERROR
        - DECISION_EVALUATION_ERROR
        - EXECUTION_LISTENER_NO_RETRIES
        - EXTRACT_VALUE_ERROR
        - FORM_NOT_FOUND
        - IO_MAPPING_ERROR
        - JOB_NO_RETRIES
        - MESSAGE_SIZE_EXCEEDED
        - RESOURCE_NOT_FOUND
        - TASK_LISTENER_NO_RETRIES
        - UNHANDLED_ERROR_EVENT
        - UNKNOWN
        - UNSPECIFIED

    IncidentStateFilterProperty:
      description: IncidentStateEnum with full advanced search capabilities.
      type: object
      oneOf:
        - type: string
          title: Exact match
          description: Matches the value exactly.
          allOf:
            - $ref: "#/components/schemas/IncidentStateEnum"
        - $ref: '#/components/schemas/AdvancedIncidentStateFilter'

    AdvancedIncidentStateFilter:
      title: Advanced filter
      description: Advanced IncidentStateEnum filter
      type: object
      properties:
        $eq:
          description: Checks for equality with the provided value.
          allOf:
            - $ref: "#/components/schemas/IncidentStateEnum"
        $neq:
          description: Checks for inequality with the provided value.
          allOf:
            - $ref: "#/components/schemas/IncidentStateEnum"
        $exists:
          description: Checks if the current property exists.
          type: boolean
        $in:
          description: Checks if the property matches any of the provided values.
          type: array
          items:
            $ref: "#/components/schemas/IncidentStateEnum"
        $notIn:
          description: Checks if the property does not match any of the provided values.
          type: array
          items:
            $ref: "#/components/schemas/IncidentStateEnum"
        $like:
          $ref: "filters.yaml#/components/schemas/LikeFilter"

    IncidentStateEnum:
      description: Incident states with a defined set of values.
      enum:
        - ACTIVE
        - MIGRATED
        - PENDING
        - RESOLVED

    IncidentSearchQuerySortRequest:
      type: object
      properties:
        field:
          description: The field to sort by.
          type: string
          enum:
            - incidentKey
            - processDefinitionKey
            - processDefinitionId
            - processInstanceKey
            - errorType
            - errorMessage
            - elementId
            - elementInstanceKey
            - creationTime
            - state
            - jobKey
            - tenantId
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field

    IncidentSearchQueryResult:
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: The matching incidents.
          type: array
          items:
            $ref: '#/components/schemas/IncidentResult'

    IncidentResult:
      type: object
      properties:
        processDefinitionId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/ProcessDefinitionId'
          description: The process definition ID associated to this incident.
        errorType:
          allOf:
            - $ref: "#/components/schemas/IncidentErrorTypeEnum"
        errorMessage:
          type: string
          description: Error message which describes the error in more detail.
        elementId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/ElementId'
          description: The element ID associated to this incident.
        creationTime:
          type: string
          format: date-time
        state:
          allOf:
            - $ref: "#/components/schemas/IncidentStateEnum"
        tenantId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
          description: The tenant ID of the incident.
        incidentKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/IncidentKey'
          description: The assigned key, which acts as a unique identifier for this incident.
        processDefinitionKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
          description: The process definition key associated to this incident.
        processInstanceKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessInstanceKey'
          description: The process instance key associated to this incident.
        elementInstanceKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ElementInstanceKey'
          description: The element instance key associated to this incident.
        jobKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/JobKey'
          description: The job key, if exists, associated with this incident.

    IncidentResolutionRequest:
      type: object
      additionalProperties: false
      properties:
        operationReference:
          $ref: 'keys.yaml#/components/schemas/OperationReference'

    IncidentProcessInstanceStatisticsByErrorQuery:
      type: object
      additionalProperties: false
      properties:
        page:
          description: |
            Pagination parameters for process instance statistics grouped by incident error.
          allOf:
            - $ref: 'search-models.yaml#/components/schemas/OffsetPagination'
        sort:
          description: Sorting criteria for process instance statistics grouped by incident error.
          type: array
          items:
            $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByErrorQuerySortRequest'

    IncidentProcessInstanceStatisticsByErrorQueryResult:
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: |
            Statistics of active process instances grouped by incident error.
          type: array
          items:
            $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByErrorResult'

    IncidentProcessInstanceStatisticsByErrorResult:
      type: object
      properties:
        errorHashCode:
          type: integer
          format: int32
          description: The hash code identifying a specific incident error..
        errorMessage:
          type: string
          description: The error message associated with the incident error hash code.
        activeInstancesWithErrorCount:
          type: integer
          format: int64
          description: |
            The number of active process instances that currently have an active incident with this error.

    IncidentProcessInstanceStatisticsByErrorQuerySortRequest:
      type: object
      properties:
        field:
          description: The field to sort the incident error statistics by.
          type: string
          enum:
            - errorMessage
            - activeInstancesWithErrorCount
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field

    IncidentProcessInstanceStatisticsByDefinitionQuery:
      type: object
      properties:
        filter:
          description: Filter criteria for the aggregated process instance statistics.
          allOf:
            - $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByDefinitionFilter'
        page:
          description: Pagination parameters for the aggregated process instance statistics.
          allOf:
            - $ref: 'search-models.yaml#/components/schemas/OffsetPagination'
        sort:
          description: Sorting criteria for process instance statistics grouped by process definition.
          type: array
          items:
            $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByDefinitionQuerySortRequest'
      required:
        - filter

    IncidentProcessInstanceStatisticsByDefinitionQueryResult:
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: |
            Statistics of active process instances with incidents, grouped by process
            definition for the specified error hash code.
          type: array
          items:
            $ref: '#/components/schemas/IncidentProcessInstanceStatisticsByDefinitionResult'

    IncidentProcessInstanceStatisticsByDefinitionResult:
      type: object
      properties:
        processDefinitionId:
          $ref: 'identifiers.yaml#/components/schemas/ProcessDefinitionId'
        processDefinitionKey:
          $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
        processDefinitionName:
          type: string
          description: The name of the process definition.
        processDefinitionVersion:
          type: integer
          description: The version of the process definition.
        tenantId:
          $ref: 'identifiers.yaml#/components/schemas/TenantId'
        activeInstancesWithErrorCount:
          type: integer
          format: int64
          description: |
            The number of active process instances that currently have an incident
            with the specified error hash code.

    IncidentProcessInstanceStatisticsByDefinitionFilter:
      description: Filter for the incident process instance statistics by definition query.
      type: object
      properties:
        errorHashCode:
          type: integer
          format: int32
          description: |
            The error hash code of the incidents to filter the process instance statistics by.
      required:
        - errorHashCode

    IncidentProcessInstanceStatisticsByDefinitionQuerySortRequest:
      type: object
      properties:
        field:
          description: The aggregated field by which the process instance statistics are sorted.
          type: string
          enum:
              - activeInstancesWithErrorCount
              - processDefinitionId
              - processDefinitionKey
              - processDefinitionName
              - processDefinitionVersion
              - tenantId
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field


