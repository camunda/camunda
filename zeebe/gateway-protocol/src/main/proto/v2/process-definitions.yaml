## Endpoint definitions

paths:
  /process-definitions/search:
    post:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: searchProcessDefinitions
      summary: Search process definitions
      description: Search for process definitions based on given criteria.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessDefinitionSearchQuery'
      responses:
        "200":
          description: The process definition search result.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessDefinitionSearchQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /process-definitions/{processDefinitionKey}:
    get:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getProcessDefinition
      summary: Get process definition
      description: Returns process definition as JSON.
      parameters:
        - name: processDefinitionKey
          in: path
          required: true
          description: >
            The assigned key of the process definition, which acts as a unique identifier for this
            process definition.
          schema:
            $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
      responses:
        "200":
          description: The process definition is successfully returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessDefinitionResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: >
            The process definition with the given key was not found.
            More details are provided in the response body.
          content:
            application/problem+json:
              schema:
                $ref: 'problem-detail.yaml#/components/schemas/ProblemDetail'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /process-definitions/{processDefinitionKey}/xml:
    get:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getProcessDefinitionXML
      summary: Get process definition XML
      description: Returns process definition as XML.
      parameters:
        - name: processDefinitionKey
          in: path
          required: true
          description: |
            The assigned key of the process definition, which acts as a unique identifier for this process definition.
          schema:
            $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
      responses:
        "200":
          description: The XML of the process definition is successfully returned.
          content:
            text/xml:
              schema:
                type: string
        "204":
          description: The process definition was found but does not have XML.
          content:
            text/plain:
              schema:
                type: string
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: |
            The process definition with the given key was not found.
            More details are provided in the response body.
          content:
            application/problem+json:
              schema:
                $ref: 'problem-detail.yaml#/components/schemas/ProblemDetail'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /process-definitions/{processDefinitionKey}/form:
    get:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getStartProcessForm
      summary: Get process start form
      description: |
        Get the start form of a process.
        Note that this endpoint will only return linked forms. This endpoint does not support embedded forms.
      parameters:
        - name: processDefinitionKey
          in: path
          required: true
          description: The process key.
          schema:
            $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
      responses:
        "200":
          description: The form is successfully returned.
          content:
            application/json:
              schema:
                $ref: 'form-models.yaml#/components/schemas/FormResult'
        "204":
          description: The process was found, but no form is associated with it.
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "404":
          description: Not found
          content:
            application/problem+json:
              schema:
                $ref: 'problem-detail.yaml#/components/schemas/ProblemDetail'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /process-definitions/{processDefinitionKey}/statistics/element-instances:
    post:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getProcessDefinitionStatistics
      summary: Get process definition statistics
      description: Get statistics about elements in currently running process instances by process definition key and search filter.
      parameters:
        - name: processDefinitionKey
          in: path
          required: true
          description: The assigned key of the process definition, which acts as a unique identifier for this process definition.
          schema:
            $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessDefinitionElementStatisticsQuery'
      responses:
        "200":
          description: The process definition statistics result.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessDefinitionElementStatisticsQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /process-definitions/statistics/message-subscriptions:
    post:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getProcessDefinitionMessageSubscriptionStatistics
      summary: Get message subscription statistics
      description: |
        Get message subscription statistics, grouped by process definition.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProcessDefinitionMessageSubscriptionStatisticsQuery"
      responses:
        "200":
          description: The process definition message subscription statistics result.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProcessDefinitionMessageSubscriptionStatisticsQueryResult"
        "400":
          $ref: "common-responses.yaml#/components/responses/InvalidData"
        "401":
          $ref: "common-responses.yaml#/components/responses/Unauthorized"
        "403":
          $ref: "common-responses.yaml#/components/responses/Forbidden"
        "500":
          $ref: "common-responses.yaml#/components/responses/InternalServerError"

  /process-definitions/statistics/process-instances:
    post:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getProcessDefinitionInstanceStatistics
      summary: Get process instance statistics
      description: |
        Get statistics about process instances, grouped by process definition and tenant.
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProcessDefinitionInstanceStatisticsQuery'
      responses:
        "200":
          description: The process definition instance statistic result.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProcessDefinitionInstanceStatisticsQueryResult'
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

  /process-definitions/{processDefinitionId}/statistics/process-instances:
    post:
      x-eventually-consistent: true
      tags:
        - Process definition
      operationId: getProcessDefinitionInstanceVersionStatistics
      summary: Get process instance statistics by version
      description: |
        Get statistics about process instances, grouped by version for a given process definition.
      parameters:
        - name: processDefinitionId
          in: path
          required: true
          description: The ID of the process definition.
          schema:
            $ref: "identifiers.yaml#/components/schemas/ProcessDefinitionId"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProcessDefinitionInstanceVersionStatisticsQuery"
      responses:
        "200":
          description: The process definition instance version statistic result.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProcessDefinitionInstanceVersionStatisticsQueryResult"
        "400":
          $ref: 'common-responses.yaml#/components/responses/InvalidData'
        "401":
          $ref: 'common-responses.yaml#/components/responses/Unauthorized'
        "403":
          $ref: 'common-responses.yaml#/components/responses/Forbidden'
        "500":
          $ref: 'common-responses.yaml#/components/responses/InternalServerError'

## Schema definitions

components:
  schemas:
    ProcessDefinitionSearchQuerySortRequest:
      type: object
      properties:
        field:
          description: The field to sort by.
          type: string
          enum:
            - processDefinitionKey
            - name
            - resourceName
            - version
            - versionTag
            - processDefinitionId
            - tenantId
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field

    ProcessDefinitionSearchQuery:
      type: object
      additionalProperties: false
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryRequest'
      properties:
        sort:
          description: Sort field criteria.
          type: array
          items:
            $ref: '#/components/schemas/ProcessDefinitionSearchQuerySortRequest'
        filter:
          allOf:
            - $ref: '#/components/schemas/ProcessDefinitionFilter'
          description: The process definition search filters.

    ProcessDefinitionFilter:
      description: Process definition search filter.
      type: object
      properties:
        name:
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
          description: Name of this process definition.
        isLatestVersion:
          description: |
            Whether to only return the latest version of each process definition.
            When using this filter, pagination functionality is limited, you can only paginate forward using `after` and `limit`.
            The response contains no `startCursor` in the `page`, and requests ignore the `from` and `before` in the `page`.
          type: boolean
        resourceName:
          description: Resource name of this process definition.
          type: string
        version:
          description: Version of this process definition.
          type: integer
          format: int32
        versionTag:
          description: Version tag of this process definition.
          type: string
        processDefinitionId:
          allOf:
            - $ref: 'filters.yaml#/components/schemas/StringFilterProperty'
          description: Process definition ID of this process definition.
        tenantId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
          description: Tenant ID of this process definition.
        processDefinitionKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
          description: The key for this process definition.
        hasStartForm:
          description: Indicates whether the start event of the process has an associated Form Key.
          type: boolean

    ProcessDefinitionSearchQueryResult:
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: The matching process definitions.
          type: array
          items:
            $ref: '#/components/schemas/ProcessDefinitionResult'

    ProcessDefinitionResult:
      type: object
      properties:
        name:
          description: Name of this process definition.
          type: string
        resourceName:
          description: Resource name for this process definition.
          type: string
        version:
          description: Version of this process definition.
          type: integer
          format: int32
        versionTag:
          description: Version tag of this process definition.
          type: string
        processDefinitionId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/ProcessDefinitionId'
          description: Process definition ID of this process definition.
        tenantId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
          description: Tenant ID of this process definition.
        processDefinitionKey:
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
          description: The key for this process definition.
        hasStartForm:
          description: Indicates whether the start event of the process has an associated Form Key.
          type: boolean

    ProcessDefinitionElementStatisticsQuery:
      description: Process definition element statistics request.
      type: object
      additionalProperties: false
      properties:
        filter:
          allOf:
            - $ref: 'process-instances.yaml#/components/schemas/ProcessDefinitionStatisticsFilter'
          description: The process definition statistics search filters.

    ProcessDefinitionElementStatisticsQueryResult:
      description: Process definition element statistics query response.
      type: object
      properties:
        items:
          description: The element statistics.
          type: array
          items:
            $ref: '#/components/schemas/ProcessElementStatisticsResult'

    ProcessElementStatisticsResult:
      description: Process element statistics response.
      type: object
      properties:
        elementId:
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/ElementId'
          description: The element ID for which the results are aggregated.
        active:
          description: The total number of active instances of the element.
          type: integer
          format: int64
        canceled:
          description: The total number of canceled instances of the element.
          type: integer
          format: int64
        incidents:
          description: The total number of incidents for the element.
          type: integer
          format: int64
        completed:
          description: The total number of completed instances of the element.
          type: integer
          format: int64

    ProcessDefinitionMessageSubscriptionStatisticsQuery:
      type: object
      properties:
        page:
          allOf:
            - $ref: "search-models.yaml#/components/schemas/CursorForwardPagination"
        filter:
          description: The message subscription filters.
          allOf:
            - $ref: "messages.yaml#/components/schemas/MessageSubscriptionFilter"

    ProcessDefinitionMessageSubscriptionStatisticsQueryResult:
      type: object
      allOf:
        - $ref: "search-models.yaml#/components/schemas/SearchQueryResponse"
      properties:
        items:
          description: The matching process definition message subscription statistics.
          type: array
          items:
            $ref: "#/components/schemas/ProcessDefinitionMessageSubscriptionStatisticsResult"

    ProcessDefinitionMessageSubscriptionStatisticsResult:
      type: object
      properties:
        processDefinitionId:
          description: The process definition ID associated with this message subscription.
          allOf:
            - $ref: "identifiers.yaml#/components/schemas/ProcessDefinitionId"
        tenantId:
          description: The tenant ID associated with this message subscription.
          allOf:
            - $ref: "identifiers.yaml#/components/schemas/TenantId"
        processDefinitionKey:
          description: The process definition key associated with this message subscription.
          allOf:
            - $ref: "keys.yaml#/components/schemas/ProcessDefinitionKey"
        processInstancesWithActiveSubscriptions:
          description: The number of process instances with active message subscriptions.
          type: integer
          format: int64
        activeSubscriptions:
          description: The total number of active message subscriptions for this process definition key.
          type: integer
          format: int64

    ProcessDefinitionInstanceStatisticsQuery:
      type: object
      properties:
        page:
          allOf:
            - $ref: 'search-models.yaml#/components/schemas/OffsetPagination'
        sort:
          description: Sort field criteria.
          type: array
          items:
            $ref: '#/components/schemas/ProcessDefinitionInstanceStatisticsQuerySortRequest'

    ProcessDefinitionInstanceStatisticsQueryResult:
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: The process definition instance statistics result.
          type: array
          items:
            $ref: '#/components/schemas/ProcessDefinitionInstanceStatisticsResult'

    ProcessDefinitionInstanceStatisticsResult:
      description: Process definition instance statistics response.
      type: object
      properties:
        processDefinitionId:
          $ref: 'identifiers.yaml#/components/schemas/ProcessDefinitionId'
        tenantId:
          $ref: 'identifiers.yaml#/components/schemas/TenantId'
        latestProcessDefinitionName:
          description: Name of the latest deployed process definition instance version.
          type: string
        hasMultipleVersions:
          description: Indicates whether multiple versions of this process definition instance are deployed.
          type: boolean
        activeInstancesWithoutIncidentCount:
          description: Total number of currently active process instances of this definition that do not have incidents.
          type: integer
          format: int64
        activeInstancesWithIncidentCount:
          description: Total number of currently active process instances of this definition that have at least one incident.
          type: integer
          format: int64

    ProcessDefinitionInstanceStatisticsQuerySortRequest:
      type: object
      properties:
        field:
          description: The field to sort by.
          type: string
          enum:
            - processDefinitionId
            - activeInstancesWithIncidentCount
            - activeInstancesWithoutIncidentCount
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field

    ProcessDefinitionInstanceVersionStatisticsQuery:
      type: object
      properties:
        page:
          description: Pagination criteria.
          allOf:
            - $ref: 'search-models.yaml#/components/schemas/OffsetPagination'
        sort:
          description: Sort field criteria.
          type: array
          items:
            $ref: '#/components/schemas/ProcessDefinitionInstanceVersionStatisticsQuerySortRequest'
        filter:
          description: The process definition instance version statistics search filters.
          allOf:
            - $ref: '#/components/schemas/ProcessDefinitionInstanceVersionStatisticsFilter'

    ProcessDefinitionInstanceVersionStatisticsFilter:
      description: Process definition instance version statistics search filter.
      type: object
      properties:
        tenantId:
          allOf:
              - $ref: 'identifiers.yaml#/components/schemas/TenantId'
          description: Tenant ID of this process definition.

    ProcessDefinitionInstanceVersionStatisticsQueryResult:
      type: object
      allOf:
        - $ref: 'search-models.yaml#/components/schemas/SearchQueryResponse'
      properties:
        items:
          description: The process definition instance version statistics result.
          type: array
          items:
            $ref: '#/components/schemas/ProcessDefinitionInstanceVersionStatisticsResult'

    ProcessDefinitionInstanceVersionStatisticsResult:
      description: Process definition instance version statistics response.
      type: object
      properties:
        processDefinitionId:
          description: The ID associated with the process definition.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/ProcessDefinitionId'
        processDefinitionKey:
          description: The unique key of the process definition.
          allOf:
            - $ref: 'keys.yaml#/components/schemas/ProcessDefinitionKey'
        processDefinitionName:
          description: The name of the process definition.
          type: string
        tenantId:
          description: The tenant ID associated with the process definition.
          allOf:
            - $ref: 'identifiers.yaml#/components/schemas/TenantId'
        processDefinitionVersion:
          description: The version number of the process definition.
          type: integer
          format: int32
        activeInstancesWithIncidentCount:
          description: The number of active process instances for this version that currently have incidents.
          type: integer
          format: int64
        activeInstancesWithoutIncidentCount:
          description: The number of active process instances for this version that do not have any incidents.
          type: integer
          format: int64
      required:
        - processDefinitionId
        - processDefinitionKey
        - tenantId
        - processDefinitionName
        - processDefinitionVersion
        - activeInstancesWithIncidentCount
        - activeInstancesWithoutIncidentCount

    ProcessDefinitionInstanceVersionStatisticsQuerySortRequest:
      type: object
      properties:
        field:
          description: The field to sort by.
          type: string
          enum:
            - processDefinitionId
            - processDefinitionKey
            - processDefinitionName
            - processDefinitionVersion
            - activeInstancesWithIncidentCount
            - activeInstancesWithoutIncidentCount
        order:
          $ref: 'search-models.yaml#/components/schemas/SortOrderEnum'
      required:
        - field
