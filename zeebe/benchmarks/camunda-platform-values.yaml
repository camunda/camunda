# Values for Camunda Platform Chart.
# https://github.com/camunda/camunda-platform-helm
#
# This file is used to override the default values of the chart.
# The values are optimized for running the load tests with a Camunda cluster on GKE.
#
# This is a YAML-formatted file.

########################################################################################
################################################### Global cluster configuration
########################################################################################
global:
  # Disable global ingress
  ingress:
    enabled: false
  image:
    # Image.repository defines the repository from which to fetch the docker images
    repository: "gcr.io/zeebe-io"
    # Image.tag defines the tag / version which should be used in the chart
    tag: 8.7.0
    ## @param global.image.pullPolicy defines the image pull policy which should be used https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy
    pullPolicy: Always
    ## @param global.image.pullSecrets can be used to configure image pull secrets https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod
    pullSecrets: []
  # By default, we run without Identity
  identity:
    auth:
      enabled: false
  # To override the names - and remove the release name from the names
  # Allows shorter names like zeebe-0, zeebe-1, etc.
  # Especially useful for the services, which are just zeebe-gateway and zeebe
  zeebeClusterName: zeebe

identity:
  enabled: false

identityKeycloak:
  enabled: false

optimize:
  enabled: false

connectors:
  enabled: false

webModeler:
  enabled: false

postgresql:
  enabled: false

operate:
  enabled: false
  image:
    tag: SNAPSHOT
  # Resources configuration to set request and limit configuration for the container https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits
  resources:
    requests:
      cpu: 600m
      memory: 400Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  # Retention can be used to define the data in Elasticsearch (ILM).
  retention:
    ## @param operate.retention.enabled if true, the ILM Policy is created and applied to the index templates.
    enabled: true
    ## @param operate.retention.minimumAge defines how old the data must be, before the data is deleted as a duration.
    minimumAge: 30m # there is no need to keep data longer for our benchmarks, otherwise we will fill up ES pretty quick

  env:
    - name: OPERATE_LOG_APPENDER
      value: Stackdriver
    - name: OPERATE_LOG_STACKDRIVER_SERVICENAME
      value: operate
    - name: OPERATE_LOG_STACKDRIVER_SERVICEVERSION
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace

  logging:
    level:
      io.camunda.operate: INFO

tasklist:
  enabled: false

zeebe:
  # Image configuration to configure the zeebe image specifics
  image:
    # Image.repository defines which image repository to use
    repository: camunda/zeebe
    tag: 8.7.0
  # ClusterSize defines the amount of brokers (=replicas), which are deployed via helm
  clusterSize: "3"
  # PartitionCount defines how many zeebe partitions are set up in the cluster
  partitionCount: "3"
  # ReplicationFactor defines how each partition is replicated, the value defines the number of nodes
  replicationFactor: "3"

  # CpuThreadCount defines how many threads can be used for the processing on each broker pod
  cpuThreadCount: 3
  # IoThreadCount defines how many threads can be used for the exporting on each broker pod
  ioThreadCount: 3

  # ContainerSecurityContext defines the security options the Zeebe broker container should be run with
  containerSecurityContext:
    ## @param securityContext.allowPrivilegeEscalation
    allowPrivilegeEscalation: true
    ## @param securityContext.privileged
    privileged: true
    ## @param securityContext.readOnlyRootFilesystem
    readOnlyRootFilesystem: true
    ## @param securityContext.runAsUser
    runAsUser: 1000
    capabilities:
      add: [ "NET_ADMIN" ]

  # JavaOpts can be used to set java options for the zeebe brokers
  javaOpts: >-
    -XX:MaxRAMPercentage=25.0
    -XX:+ExitOnOutOfMemoryError
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:HeapDumpPath=/usr/local/zeebe/data
    -XX:ErrorFile=/usr/local/zeebe/data/zeebe_error%p.log
    -Xlog:gc*:file=/usr/local/zeebe/data/gc.log:time:filecount=7,filesize=8M

  # We set extra configuration to configure additional settings for Broker and Gateway, that are part
  # of the orchestration cluster.
  # This allows adding configurations without the need of overwriting all environment variables from the Platform chart.
  extraConfiguration:
    application.yml: |
      zeebe.broker.experimental.consistencyChecks.enablePreconditions: "true"
      zeebe.broker.experimental.consistencyChecks.enableForeignKeyChecks: "true"
      zeebe.broker.executionMetricsExporterEnabled: "true"
      zeebe.broker.data.diskUsageCommandWatermark: "0.8"
      zeebe.broker.data.diskUsageReplicationWatermark: "0.9"
      # Configure index suffix with hour pattern, so we create every hour a new index
      # such that ILM can clean it up quickly
      zeebe.broker.exporters.elasticsearch.args.index.indexSuffixDatePattern: "yyyy-MM-dd_HH"
      # Configure a rate limit for all writes, so that we can visualize flow control metrics.
      zeebe.broker.flowControl.write.enabled: "true"
      zeebe.broker.flowControl.write.limit: 4000

  # Zeebe config
  extraVolumes:
    - name: logs
      emptyDir: {}
  ## @param zeebe.extraVolumeMounts can be used to mount extra volumes for the broker pods
  extraVolumeMounts:
    - name: logs
      mountPath: /usr/local/zeebe/logs

  # Retention can be used to define the data in Elasticsearch (ILM).
  retention:
    ## @param zeebe.retention.enabled if true, the ILM Policy is created and applied to the index templates.
    enabled: true
    ## @param zeebe.retention.minimumAge defines how old the data must be, before the data is deleted as a duration.
    minimumAge: 10m # set it to a higher value if we run with operate, so operate has enough time to consume the data

  # Environment variables
  env:
    - name: K8S_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: K8S_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    # Enable JSON logging for google cloud stackdriver
    - name: ZEEBE_LOG_APPENDER
      value: Stackdriver
    - name: ZEEBE_LOG_STACKDRIVER_SERVICENAME
      value: zeebe
    - name: ZEEBE_LOG_STACKDRIVER_SERVICEVERSION
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: ATOMIX_LOG_LEVEL
      value: INFO
    - name: ZEEBE_LOG_LEVEL
      value: DEBUG
    # To be able to load a separate/additional configuration
    # See https://github.com/camunda/camunda-platform-helm/issues/2197
    - name: SPRING_CONFIG_ADDITIONALLOCATION
      value: "/usr/local/zeebe/config/application.yml"

  # Resources configuration to set request and limit configuration for the container https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limitsS
  resources:
    limits:
      cpu: 1700m
      memory: 4Gi
    requests:
      cpu: 1350m
      memory: 4Gi

  nodeSelector:
    cloud.google.com/gke-nodepool: n2-standard-2

  # PvcAccessModes can be used to configure the persistent volume claim access mode https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes
  pvcAccessMode: [ "ReadWriteOnce" ]
  # PvcSize defines the persistent volume claim size, which is used by each broker pod https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims
  pvcSize: 48Gi
  # PvcStorageClassName can be used to set the storage class name which should be used by the persistent volume claim. It is recommended to use a storage class, which is backed with a SSD.
  pvcStorageClassName: ssd

zeebeGateway:
  # Replicas defines how many standalone gateways are deployed
  replicas: 2

  # Image configuration to configure the zeebe-gateway image specifics
  image:
    # Image.repository defines which image repository to use
    repository: camunda/zeebe
    tag: 8.7.0
  # LogLevel defines the log level which is used by the gateway
  logLevel: debug

  # We set extra configuration to configure additional settings for Broker and Gateway, that are part
  # of the orchestration cluster.
  # This allows adding configurations without the need of overwriting all environment variables from the Platform chart.
  extraConfiguration:
    application.yml: |
      zeebe.gateway.monitoring.enabled: "true"
      zeebe.gateway.threads.managementThreads: "1"

  # Zeebe config
  extraVolumes:
    - name: logs
      emptyDir: {}
  ## @param zeebeGateway.extraVolumeMounts can be used to mount extra volumes for the broker pods
  extraVolumeMounts:
    - name: logs
      mountPath: /usr/local/zeebe/logs

  # Env can be used to set extra environment variables in each gateway container
  env:
    - name: ZEEBE_LOG_APPENDER
      value: Stackdriver
    - name: ZEEBE_LOG_STACKDRIVER_SERVICENAME
      value: zeebe
    - name: ZEEBE_LOG_STACKDRIVER_SERVICEVERSION
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: ATOMIX_LOG_LEVEL
      value: INFO
    - name: ZEEBE_LOG_LEVEL
      value: DEBUG
    # To be able to load a separate/additional configuration
    # See https://github.com/camunda/camunda-platform-helm/issues/2197
    - name: SPRING_CONFIG_ADDITIONALLOCATION
      value: "/usr/local/zeebe/config/application.yml"
    - name: CAMUNDA_REST_QUERY_ENABLED
      value: "true"

  # Resources configuration to set request and limit configuration for the container https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits
  resources:
    limits:
      cpu: 450m
      memory: 1Gi
    requests:
      cpu: 450m
      memory: 1Gi

# Change these settings to configure a different way to collect metrics
prometheusServiceMonitor:
  enabled: true
  labels:
    release: monitoring
  scrapeInterval: 30s

# ELASTIC
elasticsearch:
  enabled: true
  imageTag: 8.9.2
  master:
    fullnameOverride: elastic
    nameOverride: elastic
    # Number of master-eligible replicas to deploy
    replicaCount: 3
    pdb:
      minAvailable: 2
    # Elasticsearch master-eligible node heap size.
    # Will be converted to -Xms3g
    heapSize: 3g
    # The resources configurations for elasticsearch containers
    persistence:
      # Persistent Volume Storage Class
      storageClass: "ssd"
      # Persistent Volume Size
      size: 16Gi
      # Persistent Volume Access Modes
      accessModes: [ "ReadWriteOnce" ]
    resources:
      requests:
        cpu: 3
        memory: 3Gi
      limits:
        cpu: 3
        memory: 6Gi
