# This file is not meant to be used directly, but in composition with the root docker-compose.yml
# If you wish to launch OC with OIDC auth, then you would run:
# docker compose -f oc.yml -f auth.oidc.yml up -d
services:
  oc:
    extends:
      file: ./oc.yml
      service: oc
    depends_on:
      keycloak:
        condition: service_healthy
    configs:
      - source: auth-oidc
        target: /usr/local/camunda/config/additional/auth/application.yml
  keycloak:
    image: keycloak/keycloak:${KEYCLOAK_VERSION}
    volumes:
      - keycloak:/opt/keycloak/data
      - ./config/realm.json:/opt/keycloak/data/import/realm.json
    ports:
      - 18080:8080
    environment:

      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN_USER}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}

    restart: on-failure
    command: ["start-dev", "--import-realm", "--health-enabled=true"]
    networks:
      - camunda
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: [ "CMD-SHELL", "{ printf 'HEAD /health/ready HTTP/1.0\r\n\r\n' >&0; grep 'HTTP/1.0 200'; } 0<>/dev/tcp/localhost/9000" ]
      interval: 5s
      timeout: 5s
      retries: 20

volumes:
  keycloak:

configs:
  auth-oidc:
    file: ./config/auth.oidc.yml
