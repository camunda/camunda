# Unified Camunda Compose - Single container running Zeebe, Operate, and Tasklist
# Based on the monorepo's consolidated setup pattern

services:
  keycloak:
    container_name: keycloak
    image: camunda/keycloak:quay-26@sha256:7ac3da1dbbb7636b438aaeee9b124ef7856d3a969c031cbf3d32efedeeaf67f3
    command: [ start ]
    ports:
      - "18080:8080"
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: dev-file
      KC_CACHE: ispn
      KC_HTTP_ENABLED: "true"
      KC_HTTP_RELATIVE_PATH: /auth
      KC_HEALTH_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
    healthcheck:
      test: bash -c "echo -e 'GET /auth HTTP/1.0\r\n\r\n' >/dev/tcp/127.0.0.1/8080 || exit 1"
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - camunda-network

  identity:
    depends_on:
      - keycloak
    restart: on-failure
    container_name: identity
    image: camunda/identity:SNAPSHOT
    ports:
      - "8081:8081"
    environment:
      SERVER_PORT: 8081
      KEYCLOAK_URL: http://keycloak:8080/auth
      IDENTITY_AUTH_PROVIDER_BACKEND_URL: http://keycloak:8080/auth/realms/camunda-platform
      KEYCLOAK_INIT_OPTIMIZE_SECRET: XALaRPl5qwTEItdwCMiPS62nVpKs7dL7
      KEYCLOAK_INIT_OPTIMIZE_ROOT_URL: http://localhost:8090
      KEYCLOAK_USERS_0_USERNAME: "demo"
      KEYCLOAK_USERS_0_PASSWORD: "demo"
      KEYCLOAK_USERS_0_FIRST_NAME: "demo"
      KEYCLOAK_USERS_0_ROLES_0: "Identity"
      KEYCLOAK_USERS_0_ROLES_1: "Optimize"
    networks:
      - camunda-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ES_VERSION:-8.19.10}
    container_name: elasticsearch
    environment:
      - cluster.name=elasticsearch
      - bootstrap.memory_lock=true
      - discovery.type=single-node
      - xpack.security.enabled=false
      - action.destructive_requires_name=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g -XX:UseSVE=0
      - CLI_JAVA_OPTS=-XX:UseSVE=0
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9300:9300"
    restart: always
    cpu_count: 4
    mem_limit: 2g
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cat/health | grep -q green" ]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - camunda-network

  camunda:
    container_name: camunda
    image: camunda/camunda:SNAPSHOT
    environment:
      # JVM Options
      - "JAVA_TOOL_OPTIONS=-Xms512m -Xmx1g"
      - "JAVA_OPTS=-XX:UseSVE=0"
      
      # Spring Profiles - Enable broker, operate, tasklist with consolidated auth
      - SPRING_PROFILES_ACTIVE=broker,operate,tasklist,dev,dev-data,consolidated-auth
      
      # Zeebe Broker Configuration
      - ZEEBE_BROKER_NETWORK_HOST=camunda
      - ZEEBE_BROKER_CLUSTER_PARTITIONS_COUNT=2
      - ZEEBE_BROKER_BACKPRESSURE_ENABLED=false
      - ZEEBE_BROKER_GATEWAY_ENABLE=true
      - ZEEBE_BROKER_GATEWAY_SECURITY_AUTHENTICATION_MODE=none
      
      # Zeebe Exporter Configuration - CamundaExporter for Operate/Tasklist
      - ZEEBE_BROKER_EXPORTERS_CAMUNDAEXPORTER_CLASSNAME=io.camunda.exporter.CamundaExporter
      - ZEEBE_BROKER_EXPORTERS_CAMUNDAEXPORTER_ARGS_CONNECT_TYPE=elasticsearch
      - ZEEBE_BROKER_EXPORTERS_CAMUNDAEXPORTER_ARGS_CONNECT_URL=http://elasticsearch:9200
      - ZEEBE_BROKER_EXPORTERS_CAMUNDAEXPORTER_ARGS_BULK_SIZE=1
      - ZEEBE_BROKER_EXPORTERS_CAMUNDAEXPORTER_ARGS_BULK_DELAY=1
      - ZEEBE_BROKER_EXPORTERS_CAMUNDAEXPORTER_ARGS_INDEX_SHOULDWAITFORIMPORTERS=false
      
      # Zeebe Exporter Configuration - ElasticsearchExporter for Optimize
      - ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_CLASSNAME=io.camunda.zeebe.exporter.ElasticsearchExporter
      - ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_URL=http://elasticsearch:9200
      - ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_INDEX_PREFIX=zeebe-record
      - ZEEBE_BROKER_EXPORTERS_ELASTICSEARCH_ARGS_BULK_SIZE=1
      
      # Database Configuration
      - CAMUNDA_DATABASE_TYPE=elasticsearch
      - CAMUNDA_DATABASE_URL=http://elasticsearch:9200
      - CAMUNDA_DATA_SECONDARYSTORAGE_TYPE=elasticsearch
      - CAMUNDA_DATA_SECONDARYSTORAGE_ELASTICSEARCH_URL=http://elasticsearch:9200
      
      # Operate Configuration
      - CAMUNDA_OPERATE_DATABASE=elasticsearch
      - CAMUNDA_OPERATE_ELASTICSEARCH_URL=http://elasticsearch:9200
      - CAMUNDA_OPERATE_ZEEBEELASTICSEARCH_URL=http://elasticsearch:9200
      - CAMUNDA_OPERATE_ZEEBE_GATEWAYADDRESS=camunda:26500
      - CAMUNDA_OPERATE_BACKUP_REPOSITORYNAME=test
      
      # Tasklist Configuration
      - CAMUNDA_TASKLIST_DATABASE=elasticsearch
      - CAMUNDA_TASKLIST_ELASTICSEARCH_URL=http://elasticsearch:9200
      - CAMUNDA_TASKLIST_ZEEBEELASTICSEARCH_URL=http://elasticsearch:9200
      - CAMUNDA_TASKLIST_ZEEBE_GATEWAYADDRESS=camunda:26500
      - CAMUNDA_TASKLIST_BACKUP_REPOSITORYNAME=test
      
      # Security Configuration - Disable authentication for development
      - CAMUNDA_SECURITY_AUTHENTICATION_METHOD=basic
      - CAMUNDA_SECURITY_AUTHENTICATION_UNPROTECTEDAPI=true
      - CAMUNDA_SECURITY_AUTHORIZATIONS_ENABLED=false
      
      # User Initialization
      - CAMUNDA_SECURITY_INITIALIZATION_USERS_0_USERNAME=demo
      - CAMUNDA_SECURITY_INITIALIZATION_USERS_0_PASSWORD=demo
      - CAMUNDA_SECURITY_INITIALIZATION_USERS_0_NAME=Demo
      - CAMUNDA_SECURITY_INITIALIZATION_USERS_0_EMAIL=demo@example.com
      - CAMUNDA_SECURITY_INITIALIZATION_DEFAULTROLES_ADMIN_USERS_0=demo
      
    ports:
      - "26500:26500"  # Zeebe gRPC Gateway
      - "8080:8080"    # REST API (Operate, Tasklist, Zeebe REST)
      - "9600:9600"    # Actuator/Management
    restart: always
    depends_on:
      - elasticsearch
    networks:
      - camunda-network

networks:
  camunda-network:
    driver: bridge
