/*
 * Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under one or more contributor license agreements.
 * Licensed under a proprietary license. See the License.txt file for more information.
 * You may not use this file except in compliance with the proprietary license.
 */
package org.camunda.optimize.data.generation.generators.impl.incident;

import lombok.RequiredArgsConstructor;
import org.camunda.optimize.dto.optimize.query.variable.VariableType;
import org.camunda.optimize.test.util.client.SimpleEngineClient;
import org.camunda.optimize.test.util.client.dto.EngineIncidentDto;
import org.camunda.optimize.test.util.client.dto.VariableValueDto;

import java.util.ArrayList;
import java.util.List;

@RequiredArgsConstructor
public class ActiveIncidentResolver implements IncidentResolver {

  private final SimpleEngineClient engineClient;

  @Override
  public void resolveIncidents() {
    final List<EngineIncidentDto> first100Incidents = engineClient.getFirst100Incidents();
    if (first100Incidents.isEmpty()) {
      return;
    }

    // we take only half of the incidents to complete to have some open ones left
    final List<EngineIncidentDto> incidentsToComplete = first100Incidents.subList(0, first100Incidents.size() / 2);
    List<String> processInstanceIdsToRetry = new ArrayList<>();
    incidentsToComplete.stream()
      .peek(incident -> processInstanceIdsToRetry.add(incident.getProcessInstanceId()))
      .forEach(incident -> {
        final VariableValueDto variableValueDto = new VariableValueDto();
        variableValueDto.setType(VariableType.BOOLEAN);
        variableValueDto.setValue(true);
        // the incident in the process is being generated by accessing a variable 'missingVariable' which
        // is not available during the start of the process. By adding it afterwards and then increasing the
        // retry the incident can be resolved.
        engineClient.addVariableToProcessInstance(incident.getProcessInstanceId(), "missingVariable", variableValueDto);
      });
    engineClient.increaseJobRetry(processInstanceIdsToRetry);
  }

}
