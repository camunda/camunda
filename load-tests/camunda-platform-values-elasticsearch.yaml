# We need to explictly enable ELS as per default this is disabled now
global:
  elasticsearch:
    enabled: true

########################################################################################
################################################### Orchestration cluster configuration
########################################################################################
orchestration:
  # We need to explicity set the secondary storage type to ELS
  data:
    secondaryStorage:
      type: elasticsearch
  # We set extra configuration to configure additional settings for Broker and Gateway, that are part
  # of the orchestration cluster.
  # This allows adding configurations without the need of overwriting all environment variables from the Platform chart.
  extraConfiguration:
    application.yml: |
      zeebe.gateway.monitoring.enabled: "true"
      zeebe.gateway.threads.managementThreads: "1"
      zeebe.broker.experimental.consistencyChecks.enablePreconditions: "true"
      zeebe.broker.experimental.consistencyChecks.enableForeignKeyChecks: "true"
      zeebe.broker.executionMetricsExporterEnabled: "true"
      zeebe.broker.data.disk.freeSpace.processing: "3GB"
      zeebe.broker.data.disk.freeSpace.replication: "2GB"
      # Configure index suffix with hour pattern, so we create every hour a new index
      # such that ILM can clean it up quickly
      # We need to configure it for the ES exporter AND the CamundaExporter
      zeebe.broker.exporters.camundaexporter.args.history.elsRolloverDateFormat: "yyyy-MM-dd-HH"
      zeebe.broker.exporters.camundaexporter.args.history.rolloverInterval: "1h"
      zeebe.broker.exporters.camundaexporter.args.history.rolloverBatchSize: 300
      zeebe.broker.exporters.camundaexporter.args.history.waitPeriodBeforeArchiving: "1m"
      # Configure a rate limit for all writes, so that we can visualize flow control metrics.
      zeebe.broker.flowControl.write.enabled: "true"
      zeebe.broker.flowControl.write.limit: 4000
      zeebe.broker.flowControl.write.throttling.enabled: "true"
      # Disable the importers
      camunda.tasklist.importerEnabled: "false"
      camunda.operate.importerEnabled: "false"
      camunda.operate.elasticsearch.numberOfShards: 3
      # Schema management has been moved out of exporter - to be bootstrap at start; once
      camunda.data.secondary-storage.retention.enabled: "true"
      # 0s causes ILM to move data asap - it is normally the default
      # https://www.elastic.co/guide/en/elasticsearch/reference/current/ilm-index-lifecycle.html#ilm-phase-transitions
      camunda.data.secondary-storage.retention.minimum-age: "70m"
      camunda.data.secondary-storage.elasticsearch.history.policy-name: "camunda-retention-policy"
      camunda.database.retention.policyName: "camunda-retention-policy"
      zeebe.broker.exporters.camundaexporter.args.history.retention.policyName: "camunda-retention-policy"
      #Metrics:
      camunda.flags.jfr.metrics: "true"
      # RocksDB memory limit setting, limits the overall RocksDB memory usage
      # ZEEBE_BROKER_EXPERIMENTAL_ROCKSDB_MEMORYLIMIT
      zeebe.broker.experimental.rocksdb.memoryLimit: "64MB"

########################################################################################
################################################### Elasticsearch cluster configuration
########################################################################################
elasticsearch:
  enabled: true
  master:
    fullnameOverride: elastic
    nameOverride: elastic
    ## @param elasticsearch.master.replicaCount defines number of master-elegible replicas to deploy
    replicaCount: 3
    pdb:
      minAvailable: 2
    ## @param elasticsearch.master.heapSize
    heapSize: 3g
    persistence:
      ## @param elasticsearch.master.persistence.size
      size: 128Gi
      storageClass: "ssd"
      accessModes: ["ReadWriteOnce"]
    resources:
      requests:
        cpu: 3
        memory: 3Gi
      limits:
        cpu: 3
        memory: 6Gi
  extraConfig:
    logger.org.elasticsearch.deprecation: "OFF"
