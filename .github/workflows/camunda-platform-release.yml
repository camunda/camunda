name: Git tag push issue workflow
on:
  workflow_call:
#    secrets:
#      VAULT_ADDR:
#        required: true
#      VAULT_ROLE_ID:
#        required: true
#      VAULT_SECRET_ID:
#        required: true
defaults:
  run:
    shell: bash
env:
#  GIT_TRACE: 1
  RELEASE_BRANCH: 28522-8.6.11-3
  GH_TOKEN: ${{ github.token }} # needs to be available for the gh CLI tool
jobs:
  release:
    name: Maven Release
    runs-on: ubuntu-latest
#    permissions: write-all
    steps:
      - name: Generate a GitHub token
        id: github-token
        uses: camunda/infra-global-github-actions/generate-github-app-token-from-vault-secrets@main
        with:
          github-app-id-vault-key: MONOREPO_RELEASE_APP_ID
          github-app-id-vault-path: secret/data/products/camunda/ci/camunda
          github-app-private-key-vault-key: MONOREPO_RELEASE_APP_PRIVATE_KEY
          github-app-private-key-vault-path: secret/data/products/camunda/ci/camunda
          vault-auth-method: approle
          vault-auth-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-auth-secret-id: ${{ secrets.VAULT_SECRET_ID}}
          vault-url: ${{ secrets.VAULT_ADDR }}
#      - uses: actions/checkout@v4
#        with:
#          ref: ${{ env.RELEASE_BRANCH }}
#          fetch-depth: 0
#          fetch-tags: true
      - name: Push Git tag
        run: |
          set -x
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git version
          git config --list
          cd ~
          git clone --branch ${{ env.RELEASE_BRANCH }} --single-branch https://x-access-token:${{ steps.github-token.outputs.token }}@github.com/camunda/camunda.git
          cd camunda
          git tag -d 8.6.11-test-SNAPSHOT-1 || true
          git push -d origin refs/tags/8.6.11-test-SNAPSHOT-1 || true
          git ls-remote --tags origin 8.6.11-test-SNAPSHOT-1
          git tag 8.6.11-test-SNAPSHOT-1
          git push -v --progress origin tag 8.6.11-test-SNAPSHOT-1
          git ls-remote --tags origin 8.6.11-test-SNAPSHOT-1
