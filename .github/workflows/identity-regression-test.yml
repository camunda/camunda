# description: Runs regression tests on Identity. Tests are defined as .http files
# test location: /qa/http
# type: CI
# owner: @camunda/identity
name: Identity API Regression Tests

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run tests on'
        required: true
        default: 'main'
      multi-tenancy:
        description: 'Enable MT?'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']
      authorizations:
        description: 'Enable Authorizations?'
        required: true
        default: 'true'
        type: choice
        options: ['true', 'false']

concurrency:
  cancel-in-progress: true
  group: ${{ format('{0}-{1}', github.workflow, github.ref == 'refs/heads/main' && github.sha || github.ref) }}

permissions:
  actions: write
  checks: write
  contents: read
  statuses: write

jobs:
  build-and-package:
    name: Build and Package Camunda
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - uses: ./.github/actions/setup-build
        with:
          dockerhub-readonly: true
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}

      - name: Build and package Camunda
        run: |
          ./mvnw -B -T2C -pl dist -am -DskipTests -DskipChecks -Dflatten.skip=true --no-transfer-progress package

      - name: Upload Camunda Distribution
        uses: actions/upload-artifact@v4
        with:
          name: camunda-dist
          path: dist/target/camunda-zeebe-*.tar.gz
          retention-days: 2

  run-http-regression-tests:
    name: Run Regression Tests
    needs: build-and-package
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event_name == 'workflow_dispatch' }}
    strategy:
      fail-fast: false
      matrix:
        env: ['local']
        case:
          - user-authorizations-tests.http
          - tenant-tests.http
          - group-tests.http
          - mapping-rules.http
          - role-tests.http
          - csrf-protection-tests.http
        include:
          - case: user-authorizations-tests.http
            hostPort: 9200
            hostTransportPort: 9300
          - case: tenant-tests.http
            hostPort: 9210
            hostTransportPort: 9310
          - case: group-tests.http
            hostPort: 9220
            hostTransportPort: 9320
          - case: mapping-rules.http
            hostPort: 9230
            hostTransportPort: 9330
          - case: role-tests.http
            hostPort: 9240
            hostTransportPort: 9340
          - case: csrf-protection-tests.http
            hostPort: 9250
            hostTransportPort: 9350

    environment: '${{ matrix.case }}'
    env:
      LC_ALL: C.UTF-8

    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.18.4
        env:
          discovery.type: single-node
          cluster.name: "ci-${{ matrix.case }}"
          bootstrap.memory_lock: true
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms1024m -Xmx1024m
        ports:
          - ${{ matrix.hostPort }}:9200
          - ${{ matrix.hostTransportPort }}:9300

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Download Camunda Distribution Artifact
        uses: actions/download-artifact@v4
        with:
          name: camunda-dist
          path: ./dist/target

      - name: Extract Distribution Tarball
        run: |
          cd ./dist/target
          tarball=$(ls camunda-zeebe-*.tar.gz)
          tar -xvzf "$tarball"

      - name: Import Secrets
        id: secrets
        uses: hashicorp/vault-action@734c523c4fbdb289cdf26dd2dc177f3627d1e140
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          exportEnv: false
          secrets: |
            secret/data/products/qa/ci/github.com/apps/camunda/entra-credentials CLIENT_ID;
            secret/data/products/qa/ci/github.com/apps/camunda/entra-credentials CLIENT_SECRET;
            secret/data/products/qa/ci/github.com/apps/camunda/entra-credentials AUDIENCE;
            secret/data/products/qa/ci/github.com/apps/camunda/entra-credentials INITIAL_CLAIM_VALUE;
            secret/data/products/qa/ci/github.com/apps/camunda/entra-credentials ISSUER_URI;
            secret/data/products/qa/ci/github.com/apps/camunda/entra-credentials TOKEN_URL;

      - name: Merge Secrets into Existing HTTP Client Env File
        run: |
          jq \
            --arg client_id "$CLIENT_ID" \
            --arg client_secret "$CLIENT_SECRET" \
            --arg token_url "$TOKEN_URL" \
            --arg audience "$AUDIENCE" \
            '.local += {
              CLIENT_ID: $client_id,
              CLIENT_SECRET: $client_secret,
              TOKEN_URL: $token_url,
              AUDIENCE: $audience
            }' qa/http/http-client.private.env.json > qa/http/tmp.env.json && mv qa/http/tmp.env.json qa/http/http-client.private.env.json
        env:
          CLIENT_ID: ${{ steps.secrets.outputs.CLIENT_ID }}
          CLIENT_SECRET: ${{ steps.secrets.outputs.CLIENT_SECRET }}
          TOKEN_URL: ${{ steps.secrets.outputs.TOKEN_URL }}
          AUDIENCE: ${{ steps.secrets.outputs.AUDIENCE }}

      - name: Wait for Elasticsearch
        run: |
          echo "Waiting for Elasticsearch on localhost:${{ matrix.hostPort }}..."
          for i in {1..60}; do
            status=$(curl -s "http://localhost:${{ matrix.hostPort }}/_cluster/health?wait_for_status=yellow&timeout=5s" | jq -r '.status // empty')
            if [[ "$status" == "yellow" || "$status" == "green" ]]; then
              echo "✅ Elasticsearch is ready (status: $status)"
              break
            fi
            echo "⏳ Still waiting for cluster health ($i/60)... current status: ${status:-unknown}"
            sleep 5
          done

          if [[ "$status" != "yellow" && "$status" != "green" ]]; then
            echo "❌ Elasticsearch did not reach yellow or green state in time" >&2
            curl -s "http://localhost:${{ matrix.hostPort }}/_cluster/health?pretty" || true
            exit 1
          fi

      - name: Start Camunda
        run: |
          export CLIENTID=${{ steps.secrets.outputs.CLIENT_ID }}
          export CLIENTSECRET=${{ steps.secrets.outputs.CLIENT_SECRET }}
          export ISSUERURI=${{ steps.secrets.outputs.ISSUER_URI }}
          export CLAIMVALUE=${{ steps.secrets.outputs.INITIAL_CLAIM_VALUE }}
          export MTCHECKSENABLED=${{ inputs.multi-tenancy }}
          export ESURL=http://localhost:${{ matrix.hostPort }}
          export CONNECTURL=http://localhost:${{ matrix.hostPort }}
          export AUTHORIZATIONS=${{ inputs.authorizations }}
          cd ./dist/target
          dir=$(ls -d camunda-zeebe-*/)
          cd "$dir"

          CONFIG_PATH="../../../qa/http/configs"
          if [ "${{ matrix.case }}" = "mapping-rules.http" ]; then
            CONFIG_FILE="$CONFIG_PATH/identity-oidc.env"
          else
            CONFIG_FILE="$CONFIG_PATH/identity-default.env"
          fi

          echo "Using config file: $CONFIG_FILE"

          # Expand GitHub variables before sourcing
          envsubst < "$CONFIG_FILE" > "$CONFIG_PATH/identity-runtime.env"
          set -a
          source "$CONFIG_PATH/identity-runtime.env"
          set +a
          rm "$CONFIG_PATH/identity-runtime.env"

          ./bin/camunda &

          echo "Waiting for Camunda to start on port 8080..."
          for i in {1..60}; do
            if nc -z localhost 8080; then
              echo "✅ Camunda is up!"
              break
            fi
            echo "⏳ Still waiting ($i/60)..."
            sleep 5
          done

          if ! nc -z localhost 8080; then
            echo "❌ Camunda did not start within expected time" >&2
            exit 1
          fi

      - name: Install IntelliJ HTTP Client
        shell: bash
        run: |
          curl -f -L -o ijhttp.zip "https://jb.gg/ijhttp/latest"
          unzip ijhttp.zip
          ijhttp/ijhttp qa/http/${{ matrix.case }} --private-env-file qa/http/http-client.private.env.json --env ${{ matrix.env }} --report -t 60000

      - name: Publish Test Report
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: '**/reports/report.xml'
          comment_mode: off

      - name: Cleanup
        shell: bash
        if: always()
        run: |
          rm qa/http/http-client.private.env.json

      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          job_name: "Run Regression Tests - ${{ matrix.case }}"
          build_status: ${{ job.status }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
