name: Check Licenses

on:
  push:
    branches:
    - main
    - stable/*
    tags:
    - '*'

jobs:
  analyze:
    name: Analyze dependencies
    permissions: {}
    runs-on: ubuntu-latest
    strategy:
      # The matrix is necessary to run separate analyses
      matrix:
        project:
        - name: optimize
          path: ./optimize
    timeout-minutes: 20
    steps:
    - uses: actions/checkout@v4
    # Import FOSSA_API_KEY secret from Vault
    - name: Import Secrets
      id: secrets
      uses: hashicorp/vault-action@v3.0.0
      with:
        url: ${{ secrets.VAULT_ADDR }}
        method: approle
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}
        secrets: |
          secret/data/products/camunda/ci/camunda FOSSA_API_KEY;
    - name: Setup Maven
      if: matrix.project.name == 'optimize'
      uses: ./.github/actions/setup-maven
      with:
        secrets: ${{ toJSON(secrets) }}
    - name: Setup fossa-cli
      # TODO: use main branch
      uses: camunda/infra-global-github-actions/fossa/setup@32470949e549396aa5f2c5def890de831b8ca107
    - name: Adjust pom.xml files for FOSSA
      if: matrix.project.name == 'optimize'
      run: |
        # Remove optimize/qa module as a bug in FOSSA prevents scope filtering
        # TODO remove this workaround once FOSSA is fixed
        yq -i \
          'del(.project.modules.module[] | select(. == "qa"))' \
          optimize/pom.xml
    - name: Analyze project
      # TODO: use main branch
      uses: camunda/infra-global-github-actions/fossa/analyze@32470949e549396aa5f2c5def890de831b8ca107
      with:
        api-key: ${{ steps.secrets.outputs.FOSSA_API_KEY }}
        branch: ${{ github.ref_name }}
        path: ${{ matrix.project.path }}
        revision-id: ${{ github.sha }}
