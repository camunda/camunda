---
# This workflow validates that pull request commits are not
# (co-)authored by GitHub Copilot. According to Camunda's Copilot
# policies (https://confluence.camunda.com/x/MoegDg),
# commits must be properly attributed to human developers
# to ensure accountability and maintain clean git history. This check
# helps prevent future history rewrites.
#
# The workflow will fail if any commits in the PR are (co-)authored by
# GitHub Copilot, requiring the developer to recreate those commits
# with proper attribution.
name: Check Copilot Commits

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  check-copilot-commits:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Check for Copilot commits
      id: copilot-check
      uses: camunda/infra-global-github-actions/check-copilot-commits@copilot-checker
      with:
        repository: ${{ github.repository }}
        branch: ${{ github.event.pull_request.head.ref }}
        base-branch: ${{ github.event.pull_request.base.ref }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Fail if Copilot commits found
      if: steps.copilot-check.outputs.copilot-commits-found == 'true'
      run: |
        # Create clickable links for each commit hash
        commit_hashes="${{ steps.copilot-check.outputs.copilot-commits-hashes }}"
        repo_url="https://github.com/${{ github.repository }}"
        commit_links=""

        for hash in ${commit_hashes}; do
          if [ -n "${commit_links}" ]; then
            commit_links="${commit_links}, "
          fi
          commit_links="${commit_links}${repo_url}/commit/${hash}"
        done

        echo "::error title=Copilot commits detected::Commits authored by GitHub Copilot found: ${commit_links}"
        echo "‚ùå Copilot commits detected in this PR!"
        echo "Commit hashes: ${{ steps.copilot-check.outputs.copilot-commits-hashes }}"
        echo ""
        echo "According to Camunda's Copilot policies, commits authored by GitHub Copilot are not allowed."
        echo "Please review and recreate these commits without Copilot assistance."
        echo ""
        echo "For more information, see: https://confluence.camunda.com/spaces/HAN/pages/245401394/GitHub+Copilot+-+AI+for+Code+and+Text+Generation"
        exit 1
