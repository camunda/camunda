# description: The Unified CI for the monorepo. This workflow runs tests for all modules in the monorepo. Any new tests are required to adhere to inclusion rules
# test location: /
# type: CI
# owner: @camunda/monorepo-devops-team
---
name: CI

on:
  push:
    branches:
      - main
      - stable/*
      - release-*
  pull_request: {}
  merge_group: {}
  workflow_dispatch: {}
  schedule:
    - cron: '0 6 * * *' # daily full build in the morning to re-populate GHA caches

# Limit workflow to 1 concurrent run per ref (branch) and trigger event (push/schedule/etc): new commit -> old runs are canceled to save costs
# Exception for main + stable/* branches: complete builds for every commit needed for confidenence
# Exception for deploy jobs that have to wait for each other to avoid overwriting
concurrency:
  cancel-in-progress: true
  group: ${{ format('{0}-{1}-{2}', github.workflow, github.event_name, (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/stable/')) && github.sha || github.ref) }}

defaults:
  run:
    # use bash shell by default to ensure pipefail behavior is the default
    # see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#exit-codes-and-error-action-preference
    shell: bash

env:
  DOCKER_PLATFORMS: "linux/amd64,linux/arm64"
  GHA_BEST_PRACTICES_LINTER: enabled

jobs:
  detect-changes:
    outputs:
      actionlint: ${{ steps.filter.outputs.actionlint }}
      commitlint: ${{ steps.filter.outputs.commitlint }}
      maven-spotless-linter: ${{ steps.filter.outputs.maven-spotless-linter }}
      java-code-changes: ${{ steps.filter.outputs.java-code-changes }}
      camunda-docker-tests: ${{ steps.filter.outputs.camunda-docker-tests}}
      identity-frontend-tests: ${{ steps.filter.outputs.identity-frontend-tests }}
      frontend-changes: ${{ steps.filter.outputs.frontend-changes }}
      zeebe-changes: ${{ steps.filter.outputs.zeebe-changes }}
      operate-backend-changes: ${{ steps.filter.outputs.operate-backend-changes }}
      operate-frontend-changes: ${{ steps.filter.outputs.operate-frontend-changes }}
      tasklist-frontend-changes: ${{ steps.filter.outputs.tasklist-frontend-changes }}
      tasklist-backend-changes: ${{ steps.filter.outputs.tasklist-backend-changes }}
      optimize-frontend-changes: ${{ steps.filter.outputs.optimize-frontend-changes }}
      optimize-backend-changes: ${{ steps.filter.outputs.optimize-backend-changes }}
      protobuf-changes: ${{ steps.filter.outputs.protobuf-changes }}
      openapi-changes: ${{ steps.filter.outputs.openapi-changes }}
      stable-branch-changes: ${{ steps.filter.outputs.stable-branch-changes }}
      rdbms-integration-tests: ${{steps.filter.outputs.rdbms-integration-tests}}
      renovate-config-changes: ${{ steps.filter.outputs.renovate-config-changes }}
      client-components-changes: ${{ steps.filter.outputs.client-components-changes }}
      docs-changes: ${{ steps.filter.outputs.docs-changes }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      # Detect changes against the base branch
      - name: Detect changes
        uses: ./.github/actions/paths-filter
        id: filter

  actionlint:
    if: needs.detect-changes.outputs.actionlint == 'true'
    name: "Lint / Actionlint"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: { }  # GITHUB_TOKEN unused in this job
    env:
      # renovate: datasource=github-releases depName=rhysd/actionlint
      ACTIONLINT_VERSION: '1.7.10'
      # renovate: datasource=github-tags depName=open-policy-agent/conftest
      CONFTEST_VERSION: '0.66.0'
    steps:
      - uses: actions/checkout@v4
      - uses: camunda/infra-global-github-actions/actionlint@main
        with:
          version: ${{ env.ACTIONLINT_VERSION }}
          ignore: |-
            property "vault_.+" is not defined in object type
            object type "{}" cannot be filtered by object filtering `.*` since it has no object element
            condition "false" is always evaluated to false
            constant expression "false" in condition
          use_shellcheck: true
      - run: |
          curl -s -L "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz" | tar xvz conftest
          ./conftest test --rego-version v0 -o github --policy .github .github/workflows/*.y*ml
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}

  commitlint:
    if: needs.detect-changes.outputs.commitlint == 'true'
    name: "Lint / Commitlint"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions: { }  # GITHUB_TOKEN unused in this job
    steps:
      - name: Determine fetch depth for checkout
        id: depth
        run: |
          echo "depth=$((${{ github.event.pull_request.commits }} + 1))" >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: ${{ steps.depth.outputs.depth }}
      - uses: wagoid/commitlint-github-action@v6
        with:
          commitDepth: ${{ github.event.pull_request.commits }}
          helpURL: https://github.com/camunda/camunda/blob/main/CONTRIBUTING.md#commit-message-guidelines
      - name: Post failure hint
        if: failure()
        run: echo "::error::Found commit message guideline violations! Check https://github.com/camunda/camunda/blob/main/CONTRIBUTING.md#commit-message-guidelines and in exceptional cases, document the reasoning and add the ci:ignore-commitlint PR label."
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}

  maven-spotless-linter:
    if: needs.detect-changes.outputs.maven-spotless-linter == 'true'
    name: "Lint / Maven Spotless"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: { }  # GITHUB_TOKEN unused in this job
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: maven-spotless-linter
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      - run: ./mvnw spotless:check
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}

  java-checks:
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    name: "Java Checks"
    needs: [ detect-changes ]
    timeout-minutes: 15
    permissions: { }  # GITHUB_TOKEN unused in this job
    runs-on: gcp-perf-core-8-default
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: java-checks
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      # Not running Maven Spotless here since it is checked in a dedicated job
      - run: ./mvnw -T1C -B -D skipTests -Dspotless.check.skip=true -P !autoFormat,checkFormat,spotbugs,skipFrontendBuild verify
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}

  build-platform-frontend:
    if: needs.detect-changes.outputs.frontend-changes == 'true'
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions: { }  # GITHUB_TOKEN unused in this job
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-frontend
        id: build-operate-fe
        with:
          directory: ./operate/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-tasklist-fe
        with:
          directory: ./tasklist/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-identity-fe
        with:
          directory: ./identity/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-optimize-fe
        with:
          directory: ./optimize/client
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}

  # Sets up test constants for both unit and integration tests. Using outputs instead of env vars so that these constants can be used in a matrix


  # =============================================================================
  # UNIT TESTS - Generated from CODEOWNERS ownership structure
  # =============================================================================
  unit-tests:
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    name: "* / ${{ matrix.owner }} / Unit / ${{ matrix.component }}"
    needs: [ detect-changes ]
    timeout-minutes: 10
    permissions: { }  # GITHUB_TOKEN unused in this job
    runs-on: gcp-perf-core-16-default
    outputs:
      flakyTests: ${{ steps.analyze-test-run.outputs.flakyTests }}
    env:
      TEST_TYPE: "Unit"
    strategy:
      fail-fast: false
      matrix:
        include:
          # @camunda/orchestration-cluster - Unit Tests
          - owner: "Orchestration Cluster"
            component: "QA ArchUnit"
            module: "QA"
            maven-modules: "'qa/archunit-tests'"

          # @camunda/camundaex - Unit Tests
          - owner: "CamundaEx"
            component: "Clients & SDKs"
            module: "Clients"
            maven-modules: "clients/java"
          - owner: "CamundaEx"
            component: "Testing Frameworks"
            module: "Testing"
            maven-modules: "testing/camunda-process-test-java,testing/camunda-process-test-spring"

          # @camunda/identity - Unit Tests
          - owner: "Identity"
            component: "Identity & Auth"
            module: "Identity"
            maven-modules: "identity,authentication,security"

          # @camunda/core-features - Unit Tests
          - owner: "Core Features"
            component: "Engine & BPMN"
            module: "Zeebe"
            maven-modules: "zeebe/auth,zeebe/bpmn-model,zeebe/dmn,zeebe/engine,zeebe/expression-language,zeebe/feel,zeebe/msgpack-core,zeebe/msgpack-value,zeebe/test-util,zeebe/util,zeebe/zb-db"
          - owner: "Core Features"
            component: "Protocol"
            module: "Zeebe"
            maven-modules: "zeebe/protocol,zeebe/protocol-asserts,zeebe/protocol-impl,zeebe/protocol-jackson,zeebe/protocol-test-util"
          - owner: "Core Features"
            component: "Gateway"
            module: "Zeebe"
            maven-modules: "zeebe/gateway,zeebe/gateway-grpc,zeebe/gateway-protocol,zeebe/gateway-protocol-impl,zeebe/gateway-rest"
          - owner: "Core Features"
            component: "QA Utilities"
            module: "Zeebe"
            maven-modules: "zeebe/qa/util"
          - owner: "Core Features"
            component: "Operate"
            module: "Operate"
            maven-modules: "operate"
          - owner: "Core Features"
            component: "Tasklist"
            module: "Tasklist"
            maven-modules: "tasklist"
          - owner: "Core Features"
            component: "Optimize"
            module: "Optimize"
            maven-modules: "optimize"
          - owner: "Core Features"
            component: "Service"
            module: "Service"
            maven-modules: "service"

          # @camunda/zeebe-distributed-platform - Unit Tests
          - owner: "Distributed Platform"
            component: "Distributed System"
            module: "Zeebe"
            maven-modules: "zeebe/atomix,zeebe/broker,zeebe/broker-client,zeebe/dynamic-config,zeebe/dynamic-node-id-provider,zeebe/journal,zeebe/logstreams,zeebe/restore,zeebe/scheduler,zeebe/snapshot,zeebe/stream-platform,zeebe/transport"
          - owner: "Distributed Platform"
            component: "Backup & Restore"
            module: "Zeebe"
            maven-modules: "zeebe/backup,zeebe/backup-stores/testkit,zeebe/backup-stores/s3,zeebe/backup-stores/gcs,zeebe/backup-stores/azure,zeebe/backup-stores/filesystem,zeebe/backup-stores/common"

          # @camunda/data-layer - Unit Tests
          - owner: "Data Layer"
            component: "Exporters"
            module: "Zeebe"
            maven-modules: "zeebe/exporter-api,zeebe/exporter-common,zeebe/exporter-test,zeebe/exporters/camunda-exporter,zeebe/exporters/elasticsearch-exporter,zeebe/exporters/opensearch-exporter,zeebe/exporters/rdbms-exporter"
          - owner: "Data Layer"
            component: "Database & Search"
            module: "Database"
            maven-modules: "db,search,schema-manager"
          - owner: "Data Layer"
            component: "Webapps Schema"
            module: "Webapps"
            maven-modules: "webapps-backup,webapps-common,webapps-schema"

          # @camunda/distribution - Unit Tests
          # (C8Run is a Go project, not a Maven module - no unit tests here)

          # @camunda/qa-engineering - Unit Tests
          - owner: "QA Engineering"
            component: "QA Utilities"
            module: "QA"
            maven-modules: "qa/util"
    steps:
      - uses: actions/checkout@v4
      - name: Print metadata
        uses: ./.github/actions/print-metadata
        with:
          test_owner: "${{ matrix.owner }}"
          test_product: "${{ matrix.module }}"
          test_type: "Unit"
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: ut-${{ matrix.module }}
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          maven-extra-args: -T1C -Dquickly
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      - name: Maven Run Unit Tests
        # we use the verify goal here as flaky test extraction is bound to the post-integration-test
        # phase of Maven https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#default-lifecycle
        # Maintain the forkCount * JVM heap size ( -Xmx ) to not exceed ~50% of the available memory
        # on the runner.
        env:
          # Set skipQaBuild based on module being tested
          SKIP_QA_BUILD: ${{ contains(matrix.maven-modules, 'qa/') && 'false' || 'true' }}
        shell: bash
        run: >
          ./mvnw -B -T 2 --no-snapshot-updates
          -D forkCount=3
          -D skipITs -D skipQaBuild=${SKIP_QA_BUILD} -D skipChecks -D surefire.rerunFailingTestsCount=3
          -D junitThreadCount=16
          -D argLine="@{argLine} -Xmx4g"
          -P skip-random-tests,parallel-tests,extract-flaky-tests,skipFrontendBuild
          -pl '${{ matrix.maven-modules }}'
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        uses: ./.github/actions/analyze-test-runs
        continue-on-error: true
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        continue-on-error: true
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        with:
          name: "[UT] ${{ matrix.owner }} - ${{ matrix.component }}"
      - name: Write matrix outputs for test analysis
        uses: cloudposse/github-action-matrix-outputs-write@v1
        continue-on-error: true
        id: matrix-write
        with:
          matrix-step-name: ${{ github.job }}
          matrix-key: ${{ matrix.owner }}-${{ matrix.component }}
          outputs: |-
            flakyTests: ${{ toJson(steps.analyze-test-run.outputs.flakyTests) }}
            hasFlaky: ${{ steps.analyze-test-run.outputs.flakyTests != '' }}
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          job_name: "unit-tests/${{ matrix.owner }}/${{ matrix.component }}"
          build_status: ${{ job.status }}
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}
          user_description: "${{ matrix.owner }}"
          detailed_junit_tests: true
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}

  elasticsearch-integration-tests:
    name: "Database Integration Tests / Elasticsearch"
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-database-integration-tests-reusable.yml
    secrets: inherit
    with:
      database-type: "elasticsearch"
      database-image-version: "8.18.4"
      it-database-type: "es"

  opensearch-integration-tests:
    name: "Database Integration Tests / Opensearch"
    uses: ./.github/workflows/ci-database-integration-tests-reusable.yml
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    needs: [ detect-changes ]
    secrets: inherit
    with:
      database-type: "opensearch"
      database-image-version: "2.17.0"
      it-database-type: "os"

  rdbms-h2-integration-tests:
    name: "Database Integration Tests / RDBMS H2"
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-database-integration-tests-reusable.yml
    secrets: inherit
    with:
      database-type: "h2"
      it-database-type: "rdbms_h2"

  elasticsearch-history-tests:
    name: "History Integration Tests / Elasticsearch"
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-database-integration-tests-reusable.yml
    secrets: inherit
    with:
      database-type: "elasticsearch"
      database-image-version: "8.18.4"
      it-database-type: "es"
      maven-profiles: "history"
      test-type-label: "History"

  opensearch-history-tests:
    name: "History Integration Tests / Opensearch"
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-database-integration-tests-reusable.yml
    secrets: inherit
    with:
      database-type: "opensearch"
      database-image-version: "2.17.0"
      it-database-type: "os"
      maven-profiles: "history"
      test-type-label: "History"

  h2-history-tests:
    name: "History Integration Tests / H2"
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-database-integration-tests-reusable.yml
    secrets: inherit
    with:
      database-type: "h2"
      it-database-type: "rdbms_h2"
      maven-profiles: "history"
      test-type-label: "History"

  rdbms-integration-tests:
    if: needs.detect-changes.outputs.rdbms-integration-tests == 'true'
    needs: [ detect-changes ]
    name: "General / Integration / RDBMS ITs"
    timeout-minutes: 10
    runs-on: gcp-perf-core-8-default
    outputs:
      flakyTests: ${{ steps.analyze-test-run.outputs.flakyTests }}
    permissions: { }  # no GITHUB_TOKEN is needed
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          dockerhub-readonly: true
          maven-cache-key-modifier: it-rdbms
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      - uses: ./.github/actions/build-zeebe
        with:
          maven-extra-args: -T1C -PskipFrontendBuild
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      # Run integration tests with RDBMS database
      - name: Maven Test Build DataLayer
        shell: bash
        run: >
          ./mvnw -B -T1C --no-snapshot-updates
          -D forkCount=1
          -D maven.javadoc.skip=true
          -D skipUTs -D skipChecks
          -D failsafe.rerunFailingTestsCount=3 -D flaky.test.reportDir=failsafe-reports
          -P rdbms,extract-flaky-tests
          -pl qa/acceptance-tests
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        uses: ./.github/actions/analyze-test-runs
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        with:
          name: "[IT] RDBMS"
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}
          user_description: "General"
          detailed_junit_tests: true
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}

  # =============================================================================
  # INTEGRATION TESTS - Generated from CODEOWNERS ownership structure
  # =============================================================================
  integration-tests:
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    name: " * / ${{ matrix.owner }} / Integration / ${{ matrix.component }}"
    needs: [ detect-changes ]
    timeout-minutes: 30
    permissions: { }  # GITHUB_TOKEN unused in this job
    runs-on: ${{ matrix.runs-on }}
    outputs:
      flakyTests: ${{ steps.analyze-test-run.outputs.flakyTests }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # @camunda/orchestration-cluster - Integration Tests
          # (Currently no integration tests for orchestration-cluster)

          # @camunda/camundaex - Integration Tests
          - owner: "CamundaEx"
            component: "Camunda Process Test"
            module: "Testing"
            maven-modules: "testing/camunda-process-test-java,testing/camunda-process-test-spring,testing/camunda-process-test-example"
            maven-build-threads: 1
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            docker-repository: localhost:5000/camunda/camunda
            docker-file: camunda.Dockerfile

          # @camunda/identity - Integration Tests
          # (Covered by separate identity-e2e-tests workflow)

          # @camunda/core-features - Integration Tests
          - owner: "Core Features"
            component: "Zeebe Engine Modules"
            module: "Zeebe"
            maven-modules: "zeebe/auth,zeebe/bpmn-model,zeebe/dmn,zeebe/engine,zeebe/expression-language,zeebe/feel,zeebe/msgpack-core,zeebe/msgpack-value,zeebe/test-util,zeebe/util,zeebe/zb-db,zeebe/protocol,zeebe/protocol-asserts,zeebe/protocol-impl,zeebe/protocol-jackson,zeebe/protocol-test-util,zeebe/gateway,zeebe/gateway-grpc,zeebe/gateway-protocol,zeebe/gateway-protocol-impl,zeebe/gateway-rest,clients/java"
            maven-build-threads: 2
            maven-test-fork-count: 7
            runs-on: gcp-perf-core-16-longrunning
            docker-repository: localhost:5000/camunda/zeebe
            docker-file: Dockerfile
          - owner: "Core Features"
            component: "Zeebe Engine QA"
            module: "Zeebe"
            maven-modules: "zeebe/qa/integration-tests"
            maven-build-threads: 1
            maven-test-fork-count: 10
            runs-on: gcp-perf-core-16-default
            test-filter: "io.camunda.zeebe.it.engine.**,!**/*$*.java"
          - owner: "Core Features"
            component: "Zeebe Update Tests"
            module: "Zeebe"
            maven-modules: "zeebe/qa/update-tests"
            maven-build-threads: 1
            maven-test-fork-count: 10
            runs-on: gcp-perf-core-8-default
            docker-repository: localhost:5000/camunda/zeebe
            docker-file: Dockerfile
          - owner: "Core Features"
            component: "Operate Integration"
            module: "Operate"
            maven-modules: "operate"
            maven-build-threads: 1
            maven-test-fork-count: 5
            runs-on: gcp-perf-core-16-default
          - owner: "Core Features"
            component: "Tasklist Integration"
            module: "Tasklist"
            maven-modules: "tasklist"
            maven-build-threads: 1
            maven-test-fork-count: 5
            runs-on: gcp-perf-core-16-default
          - owner: "Core Features"
            component: "Optimize Integration"
            module: "Optimize"
            maven-modules: "optimize"
            maven-build-threads: 1
            maven-test-fork-count: 5
            runs-on: gcp-perf-core-16-default
          - owner: "Core Features"
            component: "Service Integration"
            module: "Service"
            maven-modules: "service"
            maven-build-threads: 1
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default

          # @camunda/zeebe-distributed-platform - Integration Tests
          - owner: "Distributed Platform"
            component: "Zeebe Distributed Modules"
            module: "Zeebe"
            maven-modules: "zeebe/atomix,zeebe/broker,zeebe/broker-client,zeebe/dynamic-config,zeebe/dynamic-node-id-provider,zeebe/journal,zeebe/logstreams,zeebe/restore,zeebe/scheduler,zeebe/snapshot,zeebe/stream-platform,zeebe/transport,zeebe/backup,zeebe/backup-stores/testkit,zeebe/backup-stores/s3,zeebe/backup-stores/gcs,zeebe/backup-stores/azure,zeebe/backup-stores/filesystem,zeebe/backup-stores/common"
            maven-build-threads: 2
            maven-test-fork-count: 7
            runs-on: gcp-perf-core-16-longrunning
            docker-repository: localhost:5000/camunda/zeebe
            docker-file: Dockerfile
          - owner: "Distributed Platform"
            component: "Zeebe Cluster QA"
            module: "Zeebe"
            maven-modules: "zeebe/qa/integration-tests"
            maven-build-threads: 1
            maven-test-fork-count: 10
            runs-on: gcp-perf-core-16-default
            docker-repository: localhost:5000/camunda/zeebe
            docker-file: Dockerfile
            test-filter: "io.camunda.zeebe.it.cluster.**,!io.camunda.zeebe.it.cluster.clustering.dynamic.ScaleUpPartitionsTest,!**/*$*.java"
          - owner: "Distributed Platform"
            component: "Zeebe Cluster ScaleUp QA"
            module: "Zeebe"
            maven-modules: "zeebe/qa/integration-tests"
            maven-build-threads: 1
            maven-test-fork-count: 1
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.zeebe.it.cluster.clustering.dynamic.ScaleUpPartitionsTest"

          # @camunda/data-layer - Integration Tests
          - owner: "Data Layer"
            component: "Zeebe Exporter Modules"
            module: "Zeebe"
            maven-modules: "zeebe/exporter-api,zeebe/exporter-common,zeebe/exporter-test,zeebe/exporters/camunda-exporter,zeebe/exporters/elasticsearch-exporter,zeebe/exporters/opensearch-exporter,zeebe/exporters/rdbms-exporter"
            maven-build-threads: 2
            maven-test-fork-count: 7
            runs-on: gcp-perf-core-16-longrunning
            docker-repository: localhost:5000/camunda/zeebe
            docker-file: Dockerfile
          - owner: "Data Layer"
            component: "Schema Manager"
            module: "Schema Manager"
            maven-modules: "schema-manager"
            maven-build-threads: 1
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            docker-repository: localhost:5000/camunda/camunda
            docker-file: camunda.Dockerfile

          # @camunda/distribution - Integration Tests
          # (C8Run tests covered separately)

          # @camunda/qa-engineering - Integration Tests
          - owner: "QA Engineering"
            component: "Zeebe General QA"
            module: "Zeebe"
            maven-modules: "zeebe/qa/integration-tests"
            maven-build-threads: 1
            maven-test-fork-count: 10
            runs-on: gcp-perf-core-16-default
            docker-repository: localhost:5000/camunda/zeebe
            docker-file: Dockerfile
            test-filter: "!io.camunda.zeebe.it.engine.**,!io.camunda.zeebe.it.cluster.**,!**/*$*.java"
    env:
      ZEEBE_TEST_DOCKER_IMAGE: localhost:5000/camunda/zeebe:current-test
      OPERATE_TEST_DOCKER_IMAGE: localhost:5000/camunda/operate:current-test
      TASKLIST_TEST_DOCKER_IMAGE: localhost:5000/camunda/tasklist:current-test
      CAMUNDA_TEST_DOCKER_IMAGE: localhost:5000/camunda/camunda:current-test
      CAMUNDA_DOCKER_IMAGE_NAME: localhost:5000/camunda/camunda
      DOCKER_IMAGE_TAG: current-test
      TEST_TYPE: Integration
    services:
      registry:
        image: registry:3
        ports:
          - 5000:5000
    steps:
      - uses: actions/checkout@v4
      - name: Generate cache key with current hour
        if: matrix.component == 'Zeebe Update Tests'
        id: cache-key
        run: echo "hour=$(date -u +%Y%m%d%H)" >> "$GITHUB_OUTPUT"
      - name: Cache Zeebe versions (hourly refresh)
        if: matrix.component == 'Zeebe Update Tests'
        uses: actions/cache@v4
        with:
          path: .cache/camunda
          key: zeebe-versions-${{ steps.cache-key.outputs.hour }}
          restore-keys: |
            zeebe-versions-
      - name: Print metadata
        uses: ./.github/actions/print-metadata
        with:
          test_owner: "${{ matrix.owner }}"
          test_product: "${{ matrix.module }}"
          test_type: "Integration"
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: it-${{ matrix.owner }}-${{ matrix.component }}
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
          minimus: true
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          maven-extra-args: -T1C -PskipFrontendBuild
      - uses: ./.github/actions/build-platform-docker
        if: ${{ matrix.docker-file != '' }}
        with:
          repository: ${{ matrix.docker-repository }}
          version: ${{ env.DOCKER_IMAGE_TAG }}
          dockerfile: ${{ matrix.docker-file }}
          push: true
          distball: ${{ steps.build-zeebe.outputs.distball }}
      # Note: No acceptance tests currently need Operate/Tasklist docker images in integration-tests
      # If needed in the future, add specific matrix entries with appropriate conditions
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      - name: Maven Test Build Integration
        env:
          GH_TOKEN: ${{ github.token }}
          # Propagate matrix test filters (may be empty for other matrix entries)
          TEST_FILTER: ${{ matrix.test-filter }}
        shell: bash
        run: >
          ./mvnw -B -T ${{ matrix.maven-build-threads }} --no-snapshot-updates
          -D forkCount=${{ matrix.maven-test-fork-count }}
          -D maven.javadoc.skip=true
          -D skipUTs -D skipChecks
          -D failsafe.rerunFailingTestsCount=3 -D flaky.test.reportDir=failsafe-reports
          -Dio.camunda.process.test.camundaDockerImageName="${{ env.CAMUNDA_DOCKER_IMAGE_NAME }}"
          -Dio.camunda.process.test.camundaDockerImageVersion="${{ env.DOCKER_IMAGE_TAG }}"
          -Dio.camunda.process.test.camundaVersion="${{ env.DOCKER_IMAGE_TAG }}"
          -P parallel-tests,extract-flaky-tests,skipFrontendBuild
          -pl ${{ matrix.maven-modules }}
          ${TEST_FILTER:+-Dit.test="${TEST_FILTER}"}
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        continue-on-error: true
        uses: ./.github/actions/analyze-test-runs
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        continue-on-error: true
        with:
          name: "[IT] ${{ matrix.owner }} - ${{ matrix.component }}"
      - name: Write matrix outputs for test analysis
        uses: cloudposse/github-action-matrix-outputs-write@v1
        id: matrix-write
        continue-on-error: true
        with:
          matrix-step-name: ${{ github.job }}
          matrix-key: ${{ matrix.owner }} - ${{ matrix.component }}
          outputs: |-
            flakyTests: ${{ toJson(steps.analyze-test-run.outputs.flakyTests) }}
            hasFlaky: ${{ steps.analyze-test-run.outputs.flakyTests != '' }}
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          job_name: "integration-tests/${{ matrix.owner }}/${{ matrix.component }}"
          build_status: ${{ job.status }}
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}
          user_description: ${{ matrix.owner }}
          detailed_junit_tests: true
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}


  # =============================================================================
  # ACCEPTANCE TESTS - Team-based matrix from CODEOWNERS
  # Tests are in io.camunda.it.* packages (same as integration tests)
  # =============================================================================
  acceptance-tests:
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    name: "* / ${{ matrix.owner }} / Acceptance / ${{ matrix.component }}"
    needs: [ detect-changes ]
    timeout-minutes: 30
    permissions: { }
    runs-on: ${{ matrix.runs-on }}
    outputs:
      flakyTests: ${{ steps.analyze-test-run.outputs.flakyTests }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # @camunda/camundaex - Acceptance Tests
          - owner: "CamundaEx"
            component: "Client"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.client.**"
          - owner: "CamundaEx"
            component: "Spring Integration"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.spring.**"

          # @camunda/identity - Acceptance Tests
          - owner: "Identity"
            component: "Identity & Auth"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.identity.**,io.camunda.it.auth.**,io.camunda.it.oidc.**,io.camunda.it.logout.**,io.camunda.it.csrf.**"

          # @camunda/core-features - Acceptance Tests
          - owner: "Core Features"
            component: "Operate"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.operate.**"
          - owner: "Core Features"
            component: "Tasklist"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.tasklist.**,io.camunda.it.task.**"
          - owner: "Core Features"
            component: "General Features"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 5
            runs-on: gcp-perf-core-16-default
            test-filter: "io.camunda.it.auditlog.**,io.camunda.it.document.**,io.camunda.it.historydeletion.**,io.camunda.it.mcp.**,io.camunda.it.orchestration.**,io.camunda.it.tenancy.**"

          # @camunda/zeebe-distributed-platform - Acceptance Tests
          - owner: "Distributed Platform"
            component: "Cluster & Backup"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.cluster.**,io.camunda.it.backup.**,io.camunda.it.network.**"

          # @camunda/data-layer - Acceptance Tests
          - owner: "Data Layer"
            component: "Database & Schema"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.rdbms.**,io.camunda.it.schema.**,io.camunda.it.nodb.**,io.camunda.it.historycleanup.**"

          # @camunda/qa-engineering - Acceptance Tests
          - owner: "QA Engineering"
            component: "Utilities & General"
            module: "Acceptance"
            maven-modules: "qa/acceptance-tests"
            maven-build-threads: 2
            maven-test-fork-count: 3
            runs-on: gcp-perf-core-8-default
            test-filter: "io.camunda.it.MultiDbTestArchTest,io.camunda.it.StandaloneCamundaTest"
    env:
      ZEEBE_TEST_DOCKER_IMAGE: localhost:5000/camunda/zeebe:current-test
      OPERATE_TEST_DOCKER_IMAGE: localhost:5000/camunda/operate:current-test
      TASKLIST_TEST_DOCKER_IMAGE: localhost:5000/camunda/tasklist:current-test
      CAMUNDA_TEST_DOCKER_IMAGE: localhost:5000/camunda/camunda:current-test
      CAMUNDA_DOCKER_IMAGE_NAME: localhost:5000/camunda/camunda
      DOCKER_IMAGE_TAG: current-test
      TEST_TYPE: Acceptance
    services:
      registry:
        image: registry:3
        ports:
          - 5000:5000
    steps:
      - uses: actions/checkout@v4
      - name: Print metadata
        uses: ./.github/actions/print-metadata
        with:
          test_owner: "${{ matrix.owner }}"
          test_product: "${{ matrix.component }}"
          test_type: "Acceptance"
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: at-${{ matrix.owner }}-${{ matrix.component }}
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
          minimus: true
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          maven-extra-args: -T1C -PskipFrontendBuild
      - uses: ./.github/actions/build-platform-docker
        with:
          repository: localhost:5000/camunda/camunda
          version: ${{ env.DOCKER_IMAGE_TAG }}
          dockerfile: camunda.Dockerfile
          distball: dist/target/camunda-zeebe-*.tar.gz
          push: true
      - uses: ./.github/actions/build-platform-docker
        with:
          repository: localhost:5000/camunda/zeebe
          version: ${{ env.DOCKER_IMAGE_TAG }}
          dockerfile: Dockerfile
          distball: dist/target/camunda-zeebe-*.tar.gz
          push: true
      - uses: ./.github/actions/build-platform-docker
        with:
          repository: localhost:5000/camunda/operate
          version: ${{ env.DOCKER_IMAGE_TAG }}
          dockerfile: operate.Dockerfile
          distball: dist/target/camunda-zeebe-*.tar.gz
          push: true
      - uses: ./.github/actions/build-platform-docker
        with:
          repository: localhost:5000/camunda/tasklist
          version: ${{ env.DOCKER_IMAGE_TAG }}
          dockerfile: tasklist.Dockerfile
          distball: dist/target/camunda-zeebe-*.tar.gz
          push: true
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      - name: Maven Run Acceptance Tests
        env:
          GH_TOKEN: ${{ github.token }}
          TEST_FILTER: ${{ matrix.test-filter }}
        shell: bash
        run: >
          ./mvnw -B -T ${{ matrix.maven-build-threads }} --no-snapshot-updates
          -D forkCount=${{ matrix.maven-test-fork-count }}
          -D maven.javadoc.skip=true
          -D skipUTs -D skipChecks
          -D failsafe.rerunFailingTestsCount=3 -D flaky.test.reportDir=failsafe-reports
          -Dio.camunda.process.test.camundaDockerImageName="${{ env.CAMUNDA_DOCKER_IMAGE_NAME }}"
          -Dio.camunda.process.test.camundaDockerImageVersion="${{ env.DOCKER_IMAGE_TAG }}"
          -Dio.camunda.process.test.camundaVersion="${{ env.DOCKER_IMAGE_TAG }}"
          -P parallel-tests,extract-flaky-tests,skipFrontendBuild
          -pl ${{ matrix.maven-modules }}
          ${TEST_FILTER:+-Dit.test="${TEST_FILTER}"}
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        uses: ./.github/actions/analyze-test-runs
        continue-on-error: true
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        continue-on-error: true
        with:
          name: "[AT] ${{ matrix.owner }} - ${{ matrix.component }}"
      - name: Write matrix outputs for test analysis
        uses: cloudposse/github-action-matrix-outputs-write@v1
        id: matrix-write
        continue-on-error: true
        with:
          matrix-step-name: ${{ github.job }}
          matrix-key: ${{ matrix.owner }}-${{ matrix.component }}
          outputs: |-
            flakyTests: ${{ toJson(steps.analyze-test-run.outputs.flakyTests) }}
            hasFlaky: ${{ steps.analyze-test-run.outputs.flakyTests != '' }}
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          job_name: "acceptance-tests/${{ matrix.owner }}/${{ matrix.component }}"
          build_status: ${{ job.status }}
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}
          user_description: "${{ matrix.owner }}"
          detailed_junit_tests: true
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}

  archunit-tests:
    if: needs.detect-changes.outputs.java-code-changes == 'true'
    name: "General / Unit - ArchUnit"
    needs: [ detect-changes ]
    timeout-minutes: 10
    permissions: { }  # GITHUB_TOKEN unused in this job
    runs-on: gcp-perf-core-16-default
    env:
      TEST_OWNER: General
      TEST_PRODUCT: Camunda
      TEST_TYPE: Unit
    outputs:
      flakyTests: ${{ steps.analyze-test-run.outputs.flakyTests }}
    steps:
      - uses: actions/checkout@v4
      - name: Print metadata
        uses: ./.github/actions/print-metadata
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: archunit-tests
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          maven-extra-args: -T1C -Dquickly
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      - name: Maven Test Build
        shell: bash
        # we use the verify goal here as flaky test extraction is bound to the post-integration-test
        # phase of Maven https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#default-lifecycle
        run: >
          ./mvnw -B --no-snapshot-updates
          -D skipITs -D skipQaBuild=false -D skipChecks -Dsurefire.rerunFailingTestsCount=3
          -P skipFrontendBuild,extract-flaky-tests
          -pl :camunda-archunit-tests
          -am
          -Dtest='*ArchTest'
          -Dsurefire.failIfNoSpecifiedTests=false
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        uses: ./.github/actions/analyze-test-runs
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        with:
          name: "[UT] General - ArchUnit"
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}
          user_description: "General"
          detailed_junit_tests: true
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}

  docker-checks:
    if: needs.detect-changes.outputs.camunda-docker-tests == 'true'
    name: "Docker / Tool / Checks"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    outputs:
      flakyTests: ${{ steps.analyze-test-run.outputs.flakyTests }}
    timeout-minutes: 15
    permissions:
      security-events: write
    services:
      # local registry is used as this job needs to push as it builds multi-platform images
      registry:
        image: registry:3
        ports:
          - 5000:5000
    env:
      LOCAL_DOCKER_IMAGE: localhost:5000/camunda/camunda
      TEST_ELASTICSEARCH_IMAGE: docker.elastic.co/elasticsearch/elasticsearch:8.16.4
      DOCKER_PLATFORMS: "linux/arm64,linux/amd64" # build AMD64 last so it gets picked up by the test
    steps:
      - uses: actions/checkout@v4
      - uses: hadolint/hadolint-action@v3.3.0
        with:
          config: ./.hadolint.yaml
          dockerfile: ./camunda.Dockerfile
          format: sarif
          output-file: ./hadolint.sarif
          no-color: true
          verbose: true
      - name: Upload Hadolint Results
        if: always()
        continue-on-error: ${{ github.event_name == 'merge_group' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ./hadolint.sarif
      - uses: ./.github/actions/setup-build
        with:
          dockerhub-readonly: true
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
          minimus: true
      - uses: ./.github/actions/build-zeebe
        id: build-camunda
        with:
          maven-extra-args: -PskipFrontendBuild,-include-optimize
      - uses: ./.github/actions/build-platform-docker
        id: build-camunda-docker
        with:
          # we use a local registry for pushing
          repository: ${{ env.LOCAL_DOCKER_IMAGE }}
          distball: ${{ steps.build-camunda.outputs.distball }}
          platforms: ${{ env.DOCKER_PLATFORMS }}
          dockerfile: camunda.Dockerfile
          # push is needed for multi-arch images as buildkit does not support loading them locally
          push: true

      # Since subsequent steps of this job need a lot of disk space for downloaded
      # database Docker images, we try to clean all unused caches and free space here.
      - name: Cleanup docker images
        run: |
          docker buildx prune -f
          docker system prune -af

      - name: Verify Docker image
        # Skip verification on fork PRs as there public base images are used that don't match our golden labels
        if: github.event_name != 'pull_request' || !github.event.pull_request.head.repo.fork
        uses: ./.github/actions/verify-platform-docker
        with:
          imageName: ${{ env.LOCAL_DOCKER_IMAGE }}
          date: ${{ steps.build-camunda-docker.outputs.date }}
          revision: ${{ github.sha }}
          version: ${{ steps.build-camunda-docker.outputs.version }}
          platforms: ${{ env.DOCKER_PLATFORMS }}
          goldenfile: camunda-docker-labels.golden.json
          dockerfile: camunda.Dockerfile
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      - name: Pull local docker image
        # We pull the image to ensure that we have the right platform image locally,
        # as the runner might be on the arm64 if that was pulled last by the verify step
        run: docker pull ${{ env.LOCAL_DOCKER_IMAGE }}:${{ steps.build-camunda-docker.outputs.version }}
      - name: Run Docker tests
        shell: bash
        # we use the verify goal here as flaky test extraction is bound to the post-integration-test
        # phase of Maven https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html#default-lifecycle
        run: >
          ./mvnw -f dist --no-snapshot-updates -DskipChecks -Dassembly.skipAssembly=true
          -DskipUTs -Dit.test=*DockerIT -Dfailsafe.rerunFailingTestsCount=3
          -P parallel-tests,extract-flaky-tests
          -Dcamunda.docker.test.enabled=true
          -Dcamunda.docker.test.image="${{ env.LOCAL_DOCKER_IMAGE }}:${{ steps.build-camunda-docker.outputs.version }}"
          -Dcamunda.docker.test.elasticsearch.image="${{ env.TEST_ELASTICSEARCH_IMAGE }}"
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        uses: ./.github/actions/analyze-test-runs
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        with:
          name: "[IT] Camunda Docker Tests"
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          detailed_junit_tests: true
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          user_description: "General"
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}

  utils-flaky-tests-summary:
    name: flaky tests summary comment
    if: always() && github.event_name == 'pull_request' && !github.event.pull_request.head.repo.fork
    needs:
      - archunit-tests
      - docker-checks
      - elasticsearch-integration-tests
      - integration-tests
      - acceptance-tests
      - opensearch-integration-tests
      - rdbms-h2-integration-tests
      - rdbms-integration-tests
      - unit-tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Read unit tests matrix outputs
        uses: cloudposse/github-action-matrix-outputs-read@v1
        id: unit-matrix-read
        with:
          matrix-step-name: unit-tests
      - name: Read Integration tests matrix outputs
        uses: cloudposse/github-action-matrix-outputs-read@v1
        id: integration-matrix-read
        with:
          matrix-step-name: integration-tests
      - name: Collect flaky test results
        id: collect-results
        uses: ./.github/actions/collect-flaky-tests
        with:
          unit-tests-result: ${{ needs.unit-tests.result }}
          unit-matrix-output-result: ${{ steps.unit-matrix-read.outputs.result }}
          elasticsearch-tests-result: ${{ needs.elasticsearch-integration-tests.result }}
          elasticsearch-tests-flaky: ${{ needs.elasticsearch-integration-tests.outputs.flakyTests }}
          opensearch-tests-result: ${{ needs.opensearch-integration-tests.result }}
          opensearch-tests-flaky: ${{ needs.opensearch-integration-tests.outputs.flakyTests }}
          rdbms-h2-tests-result: ${{ needs.rdbms-h2-integration-tests.result }}
          rdbms-h2-tests-flaky: ${{ needs.rdbms-h2-integration-tests.outputs.flakyTests }}
          rdbms-tests-result: ${{ needs.rdbms-integration-tests.result }}
          rdbms-tests-flaky: ${{ needs.rdbms-integration-tests.outputs.flakyTests }}
          docker-checks-result: ${{ needs.docker-checks.result }}
          docker-checks-flaky: ${{ needs.docker-checks.outputs.flakyTests }}
          integration-tests-result: ${{ needs.integration-tests.result }}
          integration-matrix-output-result: ${{ steps.integration-matrix-read.outputs.result }}
      - name: Update flaky tests comment
        uses: ./.github/actions/flaky-tests-summary-comment
        with:
          flaky-tests-data: '${{ steps.collect-results.outputs.flaky_tests_data }}'
          pr-number: ${{ github.event.pull_request.number }}
          branch-name: ${{ github.event.pull_request.head.ref }}
      - name: Delete matrix job generated artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            zeebe-unit-tests-*
            integration-tests-*

  identity-frontend-tests:
    if: needs.detect-changes.outputs.identity-frontend-tests == 'true'
    name: "Identity / Unit - Front End"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: { }  # GITHUB_TOKEN unused in this job
    defaults:
      run:
        working-directory: identity/client
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: 'npm'
          cache-dependency-path: 'identity/client/package-lock.json'
      - name: Install dependencies
        run: npm ci
      - name: Check formatting
        run: npm run test:format
      - name: Lint code
        run: npm run test:lint
      - name: Unit & Integration tests
        run: npm run test:unit
      - name: Check licenses
        run: npm run test:licenses
      - name: Build frontend
        run: npm run build
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          user_description: "Identity"

  tasklist-ci:
    if: needs.detect-changes.outputs.java-code-changes == 'true' || needs.detect-changes.outputs.frontend-changes == 'true'
    name: "Tasklist"
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-tasklist.yml
    secrets: inherit
    permissions: { }
    with:
      runFeTests: ${{ needs.detect-changes.outputs.tasklist-frontend-changes  == 'true' }}
      runBeTests: ${{ needs.detect-changes.outputs.tasklist-backend-changes == 'true' || needs.detect-changes.outputs.zeebe-changes == 'true' }}

  operate-ci:
    if: needs.detect-changes.outputs.java-code-changes == 'true' || needs.detect-changes.outputs.frontend-changes == 'true'
    name: "Operate"
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-operate.yml
    secrets: inherit
    permissions: { }
    with:
      runFeTests: ${{ needs.detect-changes.outputs.operate-frontend-changes == 'true' }}
      runBeTests: ${{ needs.detect-changes.outputs.operate-backend-changes == 'true' || needs.detect-changes.outputs.zeebe-changes == 'true'}}

  optimize-ci:
    if: ${{ needs.detect-changes.outputs.java-code-changes == 'true' || needs.detect-changes.outputs.frontend-changes == 'true' }}
    name: "Optimize"
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-optimize.yml
    secrets: inherit
    permissions: { }
    with:
      runFeTests: ${{ needs.detect-changes.outputs.optimize-frontend-changes == 'true' }}
      runBeTests: ${{ needs.detect-changes.outputs.optimize-backend-changes == 'true' || needs.detect-changes.outputs.zeebe-changes == 'true' }}

  zeebe-ci:
    if: needs.detect-changes.outputs.zeebe-changes == 'true'
    name: "Zeebe"
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-zeebe.yml
    secrets: inherit
    with:
      stable-branch: ${{ needs.detect-changes.outputs.stable-branch-changes == 'true' }}

  client-components:
    if: needs.detect-changes.outputs.client-components-changes == 'true'
    name: "Client Components"
    needs: [ detect-changes ]
    uses: ./.github/workflows/ci-client-components.yml
    secrets: inherit
    permissions: { }

  protobuf-checks:
    name: "Protobuf Backwards Compatibility"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    env:
      # set the comparison based on the type of workflow trigger:
      #   - for PRs, we use the last commit of the base
      #   - for merge queues, we use the last commit of the target merge queue
      #   - for a push, we use the last commit before the push
      BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha || github.event.before }}
    if: needs.detect-changes.outputs.protobuf-changes == 'true'
    steps:
      - uses: actions/checkout@v4
      - id: pr-body
        name: Fetch latest PR body
        if: github.event_name == 'pull_request'
        run: |
          {
            echo 'result<<EOF'
            gh pr view ${{ github.event.pull_request.number }} --json body | jq '.body'
            echo EOF
          } >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}
        # by the default the action will compare against the base branch, or if on push, against the
        # previous commit
      - uses: bufbuild/buf-action@v1
        if: |
          !(contains(steps.pr-body.outputs.result, 'BREAKING CHANGE:') ||
            contains(github.event.merge_group.head_commit.message, 'BREAKING CHANGE:') ||
            contains(github.event.push.commits.*.message, 'BREAKING CHANGE:'))
        with:
          format: false
          lint: false
          push: false
          archive: false
          breaking: true
          breaking_against: '${{ github.event.repository.clone_url }}#format=git,commit=${{ env.BASE_SHA }}'
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          user_description: "General"

  openapi-lint:
    name: "Lint / C8 REST OpenAPI"
    if: needs.detect-changes.outputs.openapi-changes == 'true'
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions: {}  # GITHUB_TOKEN unused in this job
    env:
      # renovate: datasource=github-releases depName=daveshanley/vacuum
      VACUUM_VERSION: 'v0.23.4'
    steps:
      - uses: actions/checkout@v4
      - name: Install vacuum
        run: |
          STRIPPED_VACUUM_VERSION="${VACUUM_VERSION#v}"
          curl -s -L "https://github.com/daveshanley/vacuum/releases/download/${VACUUM_VERSION}/vacuum_${STRIPPED_VACUUM_VERSION}_Linux_x86_64.tar.gz" | tar xvz vacuum
        shell: bash
      - name: Run OpenAPI Linter
        run: >
          ./vacuum lint zeebe/gateway-protocol/src/main/proto/v2/rest-api.yaml
          --ruleset zeebe/gateway-protocol/vacuum-ruleset.yaml
          --ignore-file zeebe/gateway-protocol/vacuum-ignores.yaml
          --functions zeebe/gateway-protocol/vacuum-rules
          --details --no-clip --errors
        shell: bash
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          user_description: "General"

  renovatelint:
    if: needs.detect-changes.outputs.renovate-config-changes == 'true'
    name: "Lint / Renovate Config Validator"
    needs: [ detect-changes ]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {}  # GITHUB_TOKEN unused in this job
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
      - run: |
          npx --yes --package "renovate@latest" -c "renovate-config-validator"
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}

  check-results:
    # Used by the merge queue to check all tests, including the unit test matrix.
    # New test jobs must be added to the `needs` lists!
    # This name is hard-coded in the branch rules; remember to update that if this name changes
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 3
    permissions:
      checks: read
    needs: # BELOW LIST IS IN ALPHABETICAL ORDER
      - actionlint
      - archunit-tests
      - build-platform-frontend
      - client-components
      - commitlint
      - detect-changes
      - docker-checks
      - elasticsearch-history-tests
      - elasticsearch-integration-tests
      - h2-history-tests
      - identity-frontend-tests
      - integration-tests
      - java-checks
      - maven-spotless-linter
      - openapi-lint
      - opensearch-history-tests
      - opensearch-integration-tests
      - operate-ci
      - optimize-ci
      - protobuf-checks
      - rdbms-h2-integration-tests
      - rdbms-integration-tests
      - renovatelint
      - tasklist-ci
      - zeebe-ci
      - unit-tests
      - acceptance-tests
    steps:
      - uses: actions/checkout@v4
      - name: Check for aborted jobs
        continue-on-error: true
        uses: ./.github/actions/observe-aborted-jobs
        with:
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
      - run: |
          echo "The \`check-results\` job has the function to fail if any previous job was unsuccessful!"
          echo "If you're reading this and wondering what the is the problem, please check other GHA jobs of this workflow run to for errors/cancellation and see their logs."

          # shellcheck disable=SC2242
          exit ${{ ((contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure')) && 1) || 0 }}


  # Dynamically generate the Docker tag (e.g., SNAPSHOT or X.Y-SNAPSHOT) and concurrency group based on branch name
  utils-get-concurrency-group-for-maven-snapshot:
    needs: [ check-results ]
    uses: ./.github/workflows/generate-snapshot-docker-tag-and-concurrency-group.yml
    secrets: inherit
    permissions:
      contents: read
    if: always() && needs.check-results.result == 'success'
    with:
      job_to_run: 'concurrency-group'
      base_group_name: deploy-maven-snapshot

  deploy-snapshots:
    name: Deploy snapshot artifacts
    needs: [ check-results, utils-get-concurrency-group-for-maven-snapshot ]
    runs-on: gcp-perf-core-8-default
    timeout-minutes: 25
    permissions: { }  # GITHUB_TOKEN unused in this job
    if: always() && needs.check-results.result == 'success' && github.repository == 'camunda/camunda' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/stable/'))
    concurrency:
      group: ${{ needs.utils-get-concurrency-group-for-maven-snapshot.outputs.concurrency_group_name }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: snapshots
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      - uses: ./.github/actions/build-frontend
        id: build-operate-fe
        with:
          directory: ./operate/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-tasklist-fe
        with:
          directory: ./tasklist/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-identity-fe
        with:
          directory: ./identity/client
          package-manager: "npm"
      # compile and generate-sources to ensure that the Javadoc can be properly generated; compile is
      # necessary when using annotation preprocessors for code generation, as otherwise the symbols are
      # not resolve-able by the Javadoc generator
      - run: ./mvnw -B -T1C -D skipTests -D skipChecks -PskipFrontendBuild compile generate-sources source:jar javadoc:jar deploy
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          user_description: "General"

  # Dynamically generate the Docker tag (e.g., SNAPSHOT or X.Y-SNAPSHOT) and concurrency group based on branch name
  utils-get-snapshot-docker-tag-and-concurrency-group:
    needs: [ check-results ]
    uses: ./.github/workflows/generate-snapshot-docker-tag-and-concurrency-group.yml
    secrets: inherit
    permissions:
      contents: read
    if: always() && needs.check-results.result == 'success'
    with:
      base_group_name: deploy-camunda-docker-snapshot

  deploy-camunda-docker-snapshot:
    name: Deploy snapshot Camunda Docker image
    needs: [ check-results, utils-get-snapshot-docker-tag-and-concurrency-group]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions: { }  # GITHUB_TOKEN unused in this job
    if: always() && needs.check-results.result == 'success' && github.repository == 'camunda/camunda' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/stable/'))
    concurrency:
      group: ${{ needs.utils-get-snapshot-docker-tag-and-concurrency-group.outputs.concurrency_group_name }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          dockerhub: true
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
          minimus: true
      - uses: ./.github/actions/build-frontend
        id: build-operate-fe
        with:
          directory: ./operate/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-tasklist-fe
        with:
          directory: ./tasklist/client
          package-manager: "npm"
      - uses: ./.github/actions/build-frontend
        id: build-identity-fe
        with:
          directory: ./identity/client
          package-manager: "npm"
      - uses: ./.github/actions/build-zeebe
        id: build-camunda
        with:
          maven-extra-args: -PskipFrontendBuild
      - uses: ./.github/actions/build-platform-docker
        id: build-camunda-docker
        with:
          repository: camunda/camunda
          version: ${{ needs.utils-get-snapshot-docker-tag-and-concurrency-group.outputs.version_tag }}
          distball: ${{ steps.build-camunda.outputs.distball }}
          platforms: ${{ env.DOCKER_PLATFORMS }}
          dockerfile: camunda.Dockerfile
          push: true
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
          user_description: "General"
