# type: Preview Environment
# owner: @camunda/monorepo-devops-team
---
name: Preview Environment Smoke Test

on:
  schedule:
  # Run weekly on Monday at 06:00 UTC
  - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      skip-teardown:
        description: |
          Skip teardown (keep environment for debugging)
        required: false
        type: boolean
        default: false

jobs:
  deploy-smoke-test:
    name: Deploy Smoke Test Preview Environment
    uses: ./.github/workflows/preview-env-build-and-deploy.yml
    secrets: inherit
    with:
      app-name: smoke-${{ github.run_number }}
      labels: |
        preview=smoke-test
        repo=camunda_camunda

  teardown-smoke-test:
    name: Teardown Smoke Test Preview Environment
    # Only run if deploy didn't fail and teardown is not skipped (via workflow_dispatch)
    if: >
      !failure() && !cancelled() && !inputs.skip-teardown
    needs:
    - deploy-smoke-test
    uses: ./.github/workflows/preview-env-teardown.yml
    secrets: inherit
    with:
      app-name: smoke-${{ github.run_number }}

  notify-failure:
    name: Notify on Failure
    # Notify on failure for scheduled runs only
    if: >
      always() &&
        needs.deploy-smoke-test.result == 'failure' &&
        github.event_name == 'schedule'
    needs:
    - deploy-smoke-test
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions: {}
    steps:
      - name: Import secrets
        id: secrets
        uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            secret/data/products/camunda/ci/camunda SLACK_TOPMONOREPOCI_WEBHOOK_URL;

      - name: Notify Slack on Failure
        uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
        with:
          webhook: ${{ steps.secrets.outputs.SLACK_TOPMONOREPOCI_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":alarm: *Preview Environment Smoke Test* failed!\n"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<!subteam^S07D6C6B18T|monorepo-ci-medic> please check <https://github.com/camunda/camunda/actions/runs/${{ github.run_id }}|workflow run>\n<https://github.com/camunda/camunda/wiki/CI-Runbooks#preview-environment-smoke-test-failure|Runbook>"
                  }
                }
              ]
            }

