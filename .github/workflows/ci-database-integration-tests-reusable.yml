# description: This is a reuseable workflow used to run Unit tests for Optimize, Tasklist, and Operate. Uses Junit5 Suite to determine which set of tests to run
# test location: Optimize, Tasklist, Operate
# type: CI
# owner: @camunda/core-features
---
name: Database integration tests reusable

on:
  workflow_call:
    inputs:
      it-database-type:
        required: true
        type: string
      database-type:
        required: true
        type: string
      database-image-version:
        required: false
        type: string
defaults:
  run:
    shell: bash

jobs:
  integration-tests:
    name: "${{inputs.database-type}}"
    timeout-minutes: 15
    permissions: { }  # GITHUB_TOKEN unused in this job
    runs-on: gcp-perf-core-8-default
    env:
      ZEEBE_TEST_DOCKER_IMAGE: localhost:5000/camunda/zeebe:current-test
      IMAGE_VERSION: ${{inputs.database-image-version}}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-build
        with:
          maven-cache-key-modifier: it-database-${{inputs.database-type}}
          vault-address: ${{ secrets.VAULT_ADDR }}
          vault-role-id: ${{ secrets.VAULT_ROLE_ID }}
          vault-secret-id: ${{ secrets.VAULT_SECRET_ID }}
      # start the required database service
      - name: Start Database service
        if: ${{ inputs.database-type != 'h2' }}
        shell: bash
        run: docker-compose -f db/docker-compose.yml up -d ${{inputs.database-type}}
      # Build the platform before running the integration tests; skipping frontend
      - uses: ./.github/actions/build-zeebe
        id: build-zeebe
        with:
          maven-extra-args: -T1C -PskipFrontendBuild
      - name: Create build output log file
        run: echo "BUILD_OUTPUT_FILE_PATH=$(mktemp)" >> "$GITHUB_ENV"
      # To communicate to the IT what database to expect and run against:
      # -Dcamunda.it.database.type=rdbms
      #
      - name: Run database integration test with ${{inputs.database-type}}
        shell: bash
        run: >
          ./mvnw -B -T 2 --no-snapshot-updates
          -D forkCount=4
          -D maven.javadoc.skip=true
          -D skipUTs -D skipChecks
          -D failsafe.rerunFailingTestsCount=3 -D flaky.test.reportDir=failsafe-reports
          -P parallel-tests,extract-flaky-tests,skipFrontendBuild,multi-db-test
          -D test.integration.camunda.database.type=${{inputs.it-database-type}}
          -pl 'qa/acceptance-tests'
          verify
          | tee "${BUILD_OUTPUT_FILE_PATH}"
      - name: Stop Database service
        shell: bash
        run: docker-compose -f db/docker-compose.yml down
      - name: Analyze Test Runs
        id: analyze-test-run
        if: always()
        uses: ./.github/actions/analyze-test-runs
        with:
          buildOutputFilePath: ${{ env.BUILD_OUTPUT_FILE_PATH }}
      - name: Upload test artifacts
        uses: ./.github/actions/collect-test-artifacts
        if: ${{ failure() || cancelled() || steps.analyze-test-run.outputs.flakyTests != '' }}
        with:
          name: "[IT] Database - ${{inputs.database-type}}"
      - name: Observe build status
        if: always()
        continue-on-error: true
        uses: ./.github/actions/observe-build-status
        with:
          build_status: ${{ job.status }}
          user_reason: ${{ (steps.analyze-test-run.outputs.flakyTests != '') && 'flaky-tests' || '' }}
          user_description: "General"
          detailed_junit_tests: true
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
