# type: Preview Environment
# owner: @camunda/monorepo-devops-team
---
name: Preview Environment Teardown

on:
  pull_request:
    types: [unlabeled, closed]
  workflow_call:
    inputs:
      app-name:
        description: |
          ArgoCD app name to tear down
        required: true
        type: string

jobs:
  teardown-preview:
    # For workflow_call: inputs.app-name is set (github.event_name is inherited from caller, not 'workflow_call')
    # For PR events: check whether the unlabel name was deploy-preview || 
    #   check whether the PR was closed/merged with deploy-preview label
    if: >
      inputs.app-name != '' || (
        github.event.label.name == 'deploy-preview' || (
          github.event.action == 'closed' &&
          contains(github.event.pull_request.labels.*.name, 'deploy-preview')
        )
      )
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
    #########################################################################
    # Sanitize the branch name to remove dependabot/,renovate/ and transform the name
    - id: sanitize
      if: inputs.app-name == ''
      uses: camunda/infra-global-github-actions/sanitize-branch-name@main
      with:
        branch: ${{ github.head_ref }} # head_ref = branch on PR
        max_length: '15'

    #########################################################################
    # Setup: import secrets from vault
    - name: Import secrets
      id: secrets
      uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
      with:
        url: ${{ secrets.VAULT_ADDR }}
        method: approle
        roleId: ${{ secrets.VAULT_ROLE_ID }}
        secretId: ${{ secrets.VAULT_SECRET_ID }}
        secrets: |
          secret/data/products/camunda/ci/camunda ARGOCD_TOKEN;

    #########################################################################
    # Setup: Generate Github Token for the Github App
    - name: Generate a GitHub token
      id: github-token
      uses: camunda/infra-global-github-actions/generate-github-app-token-from-vault-secrets@main
      with:
        github-app-id-vault-key: GITHUB_PREVIEW_ENVIRONMENTS_APP_ID
        github-app-id-vault-path: secret/data/products/camunda/ci/camunda
        github-app-private-key-vault-key: GITHUB_PREVIEW_ENVIRONMENTS_APP_PRIVATE_KEY
        github-app-private-key-vault-path: secret/data/products/camunda/ci/camunda
        vault-auth-method: approle
        vault-auth-role-id: ${{ secrets.VAULT_ROLE_ID }}
        vault-auth-secret-id: ${{ secrets.VAULT_SECRET_ID}}
        vault-url: ${{ secrets.VAULT_ADDR }}

    #########################################################################
    # Setup: checkout code. This is required because we are using
    # composite actions and deployment manifests.
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    #########################################################################
    # Tear down preview environment
    - name: Tear down Preview Environment
      uses: camunda/infra-global-github-actions/preview-env/destroy@main
      with:
        revision: ${{ github.head_ref || github.ref_name }}
        argocd_token: ${{ steps.secrets.outputs.ARGOCD_TOKEN }}
        app_name: camunda-${{ inputs.app-name || steps.sanitize.outputs.branch_name }}
        argocd_server: argocd.int.camunda.com
        github_token: ${{ steps.github-token.outputs.token }}

    - name: Observe build status
      if: always()
      continue-on-error: true
      uses: ./.github/actions/observe-build-status
      with:
        build_status: ${{ job.status }}
        job_name: preview-env-teardown
        secret_vault_address: ${{ secrets.VAULT_ADDR }}
        secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
        secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}

  clean:
    if: >
      always() && 
        needs.teardown-preview.result != 'skipped' && 
        github.event_name == 'pull_request'
    uses: camunda/camunda/.github/workflows/preview-env-clean.yml@main
    needs: [teardown-preview]
    secrets: inherit
    with:
      pull-request: ${{ github.event.pull_request.number }}

  comment:
    if: >
      always() && 
        needs.teardown-preview.result != 'skipped' && 
        github.event_name == 'pull_request'
    name: Remove Deployment Result Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [teardown-preview]
    steps:
    - uses: camunda/infra-global-github-actions/preview-env/comment@main

    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Observe build status
      if: always()
      continue-on-error: true
      uses: ./.github/actions/observe-build-status
      with:
        build_status: ${{ job.status }}
        job_name: preview-env-teardown-comment
        secret_vault_address: ${{ secrets.VAULT_ADDR }}
        secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
        secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
