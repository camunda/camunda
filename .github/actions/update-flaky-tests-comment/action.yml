---
name: Update Flaky Tests Comment

description: Creates or updates a PR comment with flaky test summary across all test jobs

inputs:
  flaky-tests-data:
    description: 'JSON array containing flaky test data from all jobs'
    required: true
  pr-number:
    description: 'Pull request number for the comment'
    required: true
  branch-name:
    description: 'Branch name where the comment will be posted'
    required: true

runs:
  using: composite
  steps:
    - name: Update Flaky Tests Comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          // Parse the flaky tests data
          const flakyTestsData = JSON.parse(`${{ inputs.flaky-tests-data }}`);
          console.log('Received flaky tests data:', flakyTestsData);

          // Early exit if no flaky tests found
          if (!Array.isArray(flakyTestsData) || flakyTestsData.length === 0) {
            console.log('[flaky-tests] No flaky tests found - skipping comment update');
            return;
          }

          // Step 1: Process and structure the flaky test data
          const { processFlakyTestsData } = require('./.github/actions/update-flaky-tests-comment/src/flaky-tests-data-processor');
          const processedData = processFlakyTestsData(flakyTestsData);
          console.log('[flaky-tests] Processed data:', JSON.stringify(processedData, null, 2));

          // Step 2: Generate and post the PR comment
          const { main } = require('./.github/actions/update-flaky-tests-comment/src/flaky-tests-comment-generator');
          console.log('[flaky-tests] ðŸš€ Generating comment...');
          await main(context, github, processedData, ${{ inputs.pr-number }}, '${{ inputs.branch-name }}');
