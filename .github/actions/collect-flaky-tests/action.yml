name: 'Collect Flaky Tests'
description: 'Collects and aggregates flaky test results from multiple CI jobs'

# owner: @camunda/monorepo-devops-team

inputs:
    general-unit-tests-result:
        description: 'Result of the general unit tests job'
        required: true
    general-unit-tests-flaky:
        description: 'Flaky tests from the general unit tests job'
        required: true
    database-integration-tests-result:
      description: 'Result of the database integration tests job'
      required: true
    database-matrix-output-result:
      description: 'Matrix output for database integration tests'
      required: true
    history-tests-result:
      description: 'Result of the history tests job'
      required: true
    history-matrix-output-result:
      description: 'Matrix output for history tests'
      required: true
    rdbms-tests-result:
        description: 'Result of the RDBMS integration tests job'
        required: true
    rdbms-tests-flaky:
        description: 'Flaky tests from the RDBMS integration tests job'
        required: true
    docker-checks-result:
        description: 'Result of the Docker checks job'
        required: true
    docker-checks-flaky:
        description: 'Flaky tests from the Docker checks job'
        required: true
    zeebe-tests-result:
        description: 'Result of the Zeebe unit tests job'
        required: true
    zeebe-matrix-output-result:
        description: 'Matrix output for Zeebe unit tests'
        required: true
    integration-tests-result:
        description: 'Result of the integration tests job'
        required: true
    integration-matrix-output-result:
        description: 'Matrix output for integration tests'
        required: true


outputs:
  flaky_tests_data:
    description: 'JSON array of flaky tests data'
    value: ${{ steps.collect-results.outputs.flaky_tests_data }}

runs:
  using: 'composite'
  steps:
    - name: Collect flaky test results
      id: collect-results
      shell: bash
      run: |
        set -euo pipefail

        # Source helper functions
        source ${{ github.action_path }}/scripts/collect-flaky-tests.sh

        # Initialize flaky data array
        flaky_data='[]'

        # Collect from single jobs
        collect_from_single_job "general-unit-tests" "${{ inputs.general-unit-tests-result }}" "${{ inputs.general-unit-tests-flaky }}"
        collect_from_single_job "rdbms-integration-tests" "${{ inputs.rdbms-tests-result }}" "${{ inputs.rdbms-tests-flaky }}"
        collect_from_single_job "docker-checks" "${{ inputs.docker-checks-result }}" "${{ inputs.docker-checks-flaky }}"

        # Collect from matrix jobs
        collect_from_matrix_job "history-tests" "${{ inputs.history-tests-result }}" '${{ inputs.history-matrix-output-result }}'
        collect_from_matrix_job "database-integration-tests" "${{ inputs.database-integration-tests-result }}" '${{ inputs.database-matrix-output-result }}'
        collect_from_matrix_job "zeebe-unit-tests" "${{ inputs.zeebe-tests-result }}" '${{ inputs.zeebe-matrix-output-result }}'
        collect_from_matrix_job "integration-tests" "${{ inputs.integration-tests-result }}" '${{ inputs.integration-matrix-output-result }}'

        # Output the collected data
        {
          echo "flaky_tests_data<<EOF"
          echo "$flaky_data"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

        # Log the collected data
        echo "Collected flaky tests data:"
        echo "$flaky_data" | jq '.'
