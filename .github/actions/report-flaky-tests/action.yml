name: Report Flaky Tests
description: Posts a Check Run using gh CLI
inputs:
  flaky-tests:
    required: true
    description: "List of flaky tests detected in the job run, formatted as a string."
  job-name:
    required: true
    description: "Name of the check run, used for context in the report."
  sha:
    required: true
    description: "The commit SHA for which the check run is being reported."
  github-token:
    description: "The GitHub token to use to use Cheks API."
    required: true

runs:
  using: "composite"
  steps:
    - name: Install GitHub CLI (Linux/macOS/Windows)
      shell: bash
      run: |
        if ! command -v gh &> /dev/null; then
          echo "Installing gh CLI..."
            sudo apt-get update
            sudo apt-get install -y gh
        else
          echo "gh CLI already installed"
        fi

    - name: Report Flaky Test Check Run
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        if [[ -n "${{ inputs.flaky-tests }}" ]]; then
          gh api -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/check-runs \
            -f name="${{ inputs.job-name }}" \
            -f head_sha="${{ inputs.sha }}" \
            -f status="completed" \
            -f conclusion="neutral" \
            -f output[title]="Flaky Tests Detected" \
            -f output[summary]="These tests were flaky in this job:" \
            -f output[text]="${{ inputs.flaky-tests }}"
        else
          echo "No flaky tests to report"
        fi
