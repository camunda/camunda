<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under
  ~ one or more contributor license agreements. See the NOTICE file distributed
  ~ with this work for additional information regarding copyright ownership.
  ~ Licensed under the Camunda License 1.0. You may not use this file
  ~ except in compliance with the Camunda License 1.0.
  -->
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="create_process_deployment_table" author="cthiel">
    <createTable tableName="PROCESS_DEFINITION">
      <column name="PROCESS_DEFINITION_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(200)" />
      <column name="NAME" type="VARCHAR(200)" />
      <column name="RESOURCE_NAME" type="VARCHAR(4000)" />
      <column name="BPMN_XML" type="CLOB" />
      <column name="TENANT_ID" type="VARCHAR(200)" />
      <column name="VERSION" type="SMALLINT" />
      <column name="VERSION_TAG" type="VARCHAR(200)" />
      <column name="FORM_ID" type="VARCHAR(200)" />
    </createTable>

    <createIndex tableName="PROCESS_DEFINITION" indexName="IDX_PROCESS_DEFINITION_ID">
      <column name="PROCESS_DEFINITION_ID" />
    </createIndex>
  </changeSet>

  <changeSet id="create_process_instance_table" author="cthiel">
    <createTable tableName="PROCESS_INSTANCE">
      <column name="PROCESS_INSTANCE_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(200)" />
      <column name="PROCESS_DEFINITION_KEY" type="BIGINT" />
      <column name="STATE" type="VARCHAR(20)" />
      <column name="START_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="END_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="TENANT_ID" type="VARCHAR(200)" />
      <column name="PARENT_PROCESS_INSTANCE_KEY" type="BIGINT" />
      <column name="PARENT_ELEMENT_INSTANCE_KEY" type="BIGINT" />
      <column name="NUM_INCIDENTS" type="SMALLINT" />
      <column name="ELEMENT_ID" type="VARCHAR(255)" />
      <column name="VERSION" type="SMALLINT" />
    </createTable>

    <modifySql dbms="mariadb">
      <!-- MariaDB doesn't support TIMESTAMP WITH TIME ZONE, but its TIMESTAMP type has already a time zone -->
      <replace replace="TIMESTAMP WITH TIME ZONE" with="TIMESTAMP"/>
    </modifySql>
  </changeSet>

  <changeSet id="create_variable_table" author="pwunderlich">
    <createTable tableName="VARIABLE">
      <column name="VAR_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="PROCESS_INSTANCE_KEY" type="BIGINT" />
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(255)" />
      <column name="SCOPE_KEY" type="BIGINT" />
      <column name="TYPE" type="VARCHAR(255)"/>
      <column name="VAR_NAME" type="VARCHAR(255)" />
      <column name="DOUBLE_VALUE" type="DOUBLE"/>
      <column name="LONG_VALUE" type="BIGINT"/>
      <column name="VAR_VALUE" type="CLOB"/> <!-- max length of 8191 -->
      <column name="VAR_FULL_VALUE" type="CLOB"/>
      <column name="TENANT_ID" type="VARCHAR(255)" />
      <column name="IS_PREVIEW" type="BOOLEAN"/>
    </createTable>

    <createIndex tableName="VARIABLE" indexName="IDX_VARIABLE_PROCESS_INSTANCE_KEY">
      <column name="PROCESS_INSTANCE_KEY" />
    </createIndex>
    <createIndex tableName="VARIABLE" indexName="IDX_VARIABLE_TENANT_ID">
      <column name="TENANT_ID" />
    </createIndex>
  </changeSet>


  <changeSet id="create_flow_node_table" author="cthiel">
    <createTable tableName="FLOW_NODE_INSTANCE">
      <column name="FLOW_NODE_INSTANCE_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="FLOW_NODE_ID" type="VARCHAR(400)" />
      <column name="PROCESS_INSTANCE_KEY" type="BIGINT" />
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(200)" />
      <column name="PROCESS_DEFINITION_KEY" type="BIGINT" />
      <column name="TYPE" type="VARCHAR(100)" />
      <column name="STATE" type="VARCHAR(20)" />
      <column name="START_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="END_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="TREE_PATH" type="VARCHAR(4000)" />
      <column name="TENANT_ID" type="VARCHAR(200)" />
      <column name="INCIDENT_KEY" type="BIGINT" />
      <column name="NUM_SUBPROCESS_INCIDENTS" type="SMALLINT" />
    </createTable>

    <modifySql dbms="mariadb">
      <!-- MariaDB doesn't support TIMESTAMP WITH TIME ZONE, but its TIMESTAMP type has already a time zone -->
      <replace replace="TIMESTAMP WITH TIME ZONE" with="TIMESTAMP"/>
    </modifySql>
  </changeSet>

  <changeSet author="pwunderlich" id="create_usertask_table">
    <createTable tableName="USER_TASK">
      <column name="USER_TASK_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="ELEMENT_ID" type="VARCHAR(200)"/>
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(200)"/>
      <column name="CREATION_DATE" type="TIMESTAMP WITH TIME ZONE(3)"/>
      <column name="COMPLETION_DATE" type="TIMESTAMP WITH TIME ZONE(3)"/>
      <column name="ASSIGNEE" type="VARCHAR(255)"/>
      <column name="STATE" type="VARCHAR(20)"/>
      <column name="FORM_KEY" type="BIGINT"/>
      <column name="PROCESS_DEFINITION_KEY" type="BIGINT"/>
      <column name="PROCESS_INSTANCE_KEY" type="BIGINT"/>
      <column name="ELEMENT_INSTANCE_KEY" type="BIGINT"/>
      <column name="TENANT_ID" type="VARCHAR(200)"/>
      <column name="DUE_DATE" type="TIMESTAMP WITH TIME ZONE(3)"/>
      <column name="FOLLOW_UP_DATE" type="TIMESTAMP WITH TIME ZONE(3)"/>
      <column name="EXTERNAL_FORM_REFERENCE" type="VARCHAR(200)"/>
      <column name="PROCESS_DEFINITION_VERSION" type="SMALLINT"/>
      <column name="CUSTOM_HEADERS" type="CLOB"/>
      <column name="PRIORITY" type="INT"/>
    </createTable>

    <createTable tableName="CANDIDATE_USER">
      <column name="USER_TASK_KEY" type="BIGINT">
        <constraints foreignKeyName="FK_CANDIDATE_USER_USER_TASK"/>
      </column>
      <column name="CANDIDATE_USER" type="VARCHAR(200)"/>
    </createTable>

    <createTable tableName="CANDIDATE_GROUP">
      <column name="USER_TASK_KEY" type="BIGINT">
        <constraints foreignKeyName="FK_CANDIDATE_GROUP_USER_TASK"/>
      </column>
      <column name="CANDIDATE_GROUP" type="VARCHAR(200)"/>
    </createTable>

    <createIndex tableName="CANDIDATE_USER" indexName="IDX_CANDIDATE_USER_USER_TASK_KEY">
      <column name="USER_TASK_KEY"/>
    </createIndex>

    <createIndex tableName="CANDIDATE_GROUP" indexName="IDX_CANDIDATE_GROUP_USER_TASK_KEY">
      <column name="USER_TASK_KEY"/>
    </createIndex>
    <modifySql dbms="mariadb">
      <!-- MariaDB doesn't support TIMESTAMP WITH TIME ZONE, but its TIMESTAMP type has already a time zone -->
      <replace replace="TIMESTAMP WITH TIME ZONE" with="TIMESTAMP"/>
    </modifySql>
  </changeSet>

  <changeSet id="create_incident" author="cthiel">
    <createTable tableName="INCIDENT">
      <column name="INCIDENT_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="FLOW_NODE_INSTANCE_KEY" type="BIGINT" />
      <column name="FLOW_NODE_ID" type="VARCHAR(400)" />
      <column name="PROCESS_INSTANCE_KEY" type="BIGINT" />
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(200)" />
      <column name="PROCESS_DEFINITION_KEY" type="BIGINT" />
      <column name="ERROR_MESSAGE" type="VARCHAR(4000)" />
      <column name="ERROR_TYPE" type="VARCHAR(100)" />
      <column name="STATE" type="VARCHAR(20)" />
      <column name="CREATION_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="END_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="TREE_PATH" type="VARCHAR(4000)" />
      <column name="TENANT_ID" type="VARCHAR(200)" />
      <column name="JOB_KEY" type="BIGINT" />
      <column name="SCOPE_KEY" type="BIGINT" />
    </createTable>

    <modifySql dbms="mariadb">
      <!-- MariaDB doesn't support TIMESTAMP WITH TIME ZONE, but its TIMESTAMP type has already a time zone -->
      <replace replace="TIMESTAMP WITH TIME ZONE" with="TIMESTAMP"/>
    </modifySql>
  </changeSet>

  <changeSet id="create_decision_definition_table" author="cthiel">
    <createTable tableName="DECISION_DEFINITION">
      <column name="DECISION_DEFINITION_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="DECISION_DEFINITION_ID" type="VARCHAR(200)" />
      <column name="NAME" type="VARCHAR(200)" />
      <column name="TENANT_ID" type="VARCHAR(255)" />
      <column name="VERSION" type="SMALLINT" />
      <column name="DECISION_REQUIREMENTS_KEY" type="BIGINT" />
      <column name="DECISION_REQUIREMENTS_ID" type="VARCHAR(255)" />
    </createTable>

    <createIndex tableName="DECISION_DEFINITION" indexName="IDX_DECISION_DEFINITION_ID">
      <column name="DECISION_DEFINITION_ID" />
    </createIndex>
  </changeSet>

  <changeSet id="create_decision_requirements_table" author="cthiel">
    <createTable tableName="DECISION_REQUIREMENTS">
      <column name="DECISION_REQUIREMENTS_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="DECISION_REQUIREMENTS_ID" type="VARCHAR(200)" />
      <column name="NAME" type="VARCHAR(200)" />
      <column name="TENANT_ID" type="VARCHAR(255)" />
      <column name="VERSION" type="SMALLINT" />
      <column name="RESOURCE_NAME" type="VARCHAR(4000)" />
      <column name="XML" type="CLOB" />
    </createTable>

    <createIndex tableName="DECISION_REQUIREMENTS" indexName="IDX_DECISION_REQUIREMENTS_ID">
      <column name="DECISION_REQUIREMENTS_ID" />
    </createIndex>
  </changeSet>

  <changeSet id="create_decision_instance_table" author="cthiel">
    <createTable tableName="DECISION_INSTANCE">
      <column name="DECISION_INSTANCE_ID" type="VARCHAR(255)" >
        <constraints primaryKey="true"/>
      </column>
      <column name="DECISION_INSTANCE_KEY" type="BIGINT" />
      <column name="PROCESS_INSTANCE_KEY" type="BIGINT" />
      <column name="PROCESS_DEFINITION_ID" type="VARCHAR(255)" />
      <column name="PROCESS_DEFINITION_KEY" type="BIGINT" />
      <column name="DECISION_DEFINITION_ID" type="VARCHAR(255)" />
      <column name="DECISION_DEFINITION_KEY" type="BIGINT" />
      <column name="DECISION_REQUIREMENTS_ID" type="VARCHAR(255)" />
      <column name="DECISION_REQUIREMENTS_KEY" type="BIGINT" />
      <column name="FLOW_NODE_ID" type="VARCHAR(255)" />
      <column name="FLOW_NODE_INSTANCE_KEY" type="BIGINT" />
      <column name="ROOT_DECISION_DEFINITION_KEY" type="BIGINT" />
      <column name="EVALUATION_DATE" type="TIMESTAMP WITH TIME ZONE(3)" />
      <column name="TYPE" type="VARCHAR(255)" />
      <column name="STATE" type="VARCHAR(255)" />
      <column name="RESULT" type="VARCHAR(255)" />
      <column name="EVALUATION_FAILURE" type="VARCHAR(255)" />
      <column name="TENANT_ID" type="VARCHAR(255)" />
    </createTable>

    <modifySql dbms="mariadb">
      <!-- MariaDB doesn't support TIMESTAMP WITH TIME ZONE, but its TIMESTAMP type has already a time zone -->
      <replace replace="TIMESTAMP WITH TIME ZONE" with="TIMESTAMP"/>
    </modifySql>
  </changeSet>

  <changeSet id="create_decision_instance_input_table" author="cthiel">
    <createTable tableName="DECISION_INSTANCE_INPUT">
      <column name="DECISION_INSTANCE_ID" type="VARCHAR(255)">
        <constraints primaryKey="true"/>
      </column>
      <column name="INPUT_ID" type="VARCHAR(255)">
        <constraints primaryKey="true"/>
      </column>
      <column name="INPUT_NAME" type="VARCHAR(255)" />
      <column name="INPUT_VALUE" type="VARCHAR(4000)" />
    </createTable>
    <!-- No additional index for DECISION_INSTANCE_KEY needed -->
  </changeSet>

  <changeSet id="create_decision_instance_output_table" author="cthiel">
    <createTable tableName="DECISION_INSTANCE_OUTPUT">
      <column name="DECISION_INSTANCE_ID" type="VARCHAR(255)">
        <constraints primaryKey="true"/>
      </column>
      <column name="OUTPUT_ID" type="VARCHAR(255)">
        <constraints primaryKey="true"/>
      </column>
      <column name="OUTPUT_NAME" type="VARCHAR(255)" />
      <column name="OUTPUT_VALUE" type="VARCHAR(4000)" />
      <column name="RULE_ID" type="VARCHAR(255)" />
      <column name="RULE_INDEX" type="SMALLINT" />
    </createTable>
    <!-- No additional index for DECISION_INSTANCE_KEY needed -->
  </changeSet>

  <changeSet id="create_user_table" author="cthiel">
    <createTable tableName="USERS">
      <column name="USER_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="USERNAME" type="VARCHAR(255)" />
      <column name="NAME" type="VARCHAR(255)" />
      <column name="EMAIL" type="VARCHAR(255)" />
      <column name="PASSWORD" type="VARCHAR(255)" />
    </createTable>
  </changeSet>

  <changeSet id="create_form_table" author="pwunderlich">
    <createTable tableName="FORM">
      <column name="FORM_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="FORM_ID" type="VARCHAR(200)"/>
      <column name="TENANT_ID" type="VARCHAR(200)"/>
      <column name="SCHEMA" type="CLOB"/>
      <column name="VERSION" type="BIGINT"/>
      <column name="IS_DELETED" type="BOOLEAN"/>
    </createTable>

    <createIndex tableName="FORM" indexName="IDX_FORM_ID">
      <column name="FORM_ID"/>
    </createIndex>
    <createIndex tableName="FORM" indexName="IDX_FORM_TENANT_ID">
      <column name="TENANT_ID"/>
    </createIndex>
  </changeSet>

  <changeSet id="create_mapping_table" author="pwunderlich">
    <createTable tableName="MAPPINGS">
      <column name="MAPPING_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="CLAIM_NAME" type="VARCHAR(255)"/>
      <column name="CLAIM_VALUE" type="VARCHAR(255)"/>
    </createTable>
  </changeSet>

  <changeSet id="create_tenant_table" author="cthiel">
    <createTable tableName="TENANT">
      <column name="TENANT_KEY" type="BIGINT">
        <constraints primaryKey="true"/>
      </column>
      <column name="TENANT_ID" type="VARCHAR(255)" />
      <column name="NAME" type="VARCHAR(255)" />
    </createTable>
  </changeSet>

  <changeSet id="tenant_members_table" author="cthiel">
    <createTable tableName="TENANT_MEMBER">
      <column name="TENANT_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="ENTITY_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="ENTITY_TYPE" type="VARCHAR(255)" />
    </createTable>
  </changeSet>


  <changeSet id="create_role_table" author="cthiel">
    <createTable tableName="ROLES">
      <column name="ROLE_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="NAME" type="VARCHAR(255)" />
    </createTable>
  </changeSet>

  <changeSet id="role_members_table" author="cthiel">
    <createTable tableName="ROLE_MEMBER">
      <column name="ROLE_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="ENTITY_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="ENTITY_TYPE" type="VARCHAR(255)" />
    </createTable>
  </changeSet>

  <changeSet id="create_group_table" author="cthiel">
    <createTable tableName="GROUPS">
      <column name="GROUP_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="NAME" type="VARCHAR(255)" />
    </createTable>
  </changeSet>

  <changeSet id="group_members_table" author="cthiel">
    <createTable tableName="GROUP_MEMBER">
      <column name="GROUP_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="ENTITY_KEY" type="BIGINT" >
        <constraints primaryKey="true"/>
      </column>
      <column name="ENTITY_TYPE" type="VARCHAR(255)" />
    </createTable>
  </changeSet>

</databaseChangeLog>
