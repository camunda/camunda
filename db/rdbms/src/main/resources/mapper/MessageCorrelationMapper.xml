<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under
  ~ one or more contributor license agreements. See the NOTICE file distributed
  ~ with this work for additional information regarding copyright ownership.
  ~ Licensed under the Camunda License 1.0. You may not use this file
  ~ except in compliance with the Camunda License 1.0.
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.camunda.db.rdbms.sql.MessageCorrelationMapper">

  <resultMap id="messageCorrelationResultMap" type="io.camunda.db.rdbms.write.domain.MessageCorrelationDbModel">
    <constructor>
      <arg column="SUBSCRIPTION_KEY" javaType="java.lang.Long" />
      <arg column="MESSAGE_KEY" javaType="java.lang.Long" />
    </constructor>
    <result property="messageName" column="MESSAGE_NAME" />
    <result property="correlationKey" column="CORRELATION_KEY" />
    <result property="processInstanceKey" column="PROCESS_INSTANCE_KEY" />
    <result property="flowNodeInstanceKey" column="FLOW_NODE_INSTANCE_KEY" />
    <result property="flowNodeId" column="FLOW_NODE_ID" />
    <result property="bpmnProcessId" column="BPMN_PROCESS_ID" />
    <result property="processDefinitionKey" column="PROCESS_DEFINITION_KEY" />
    <result property="tenantId" column="TENANT_ID" />
    <result property="dateTime" column="DATE_TIME" />
    <result property="partitionId" column="PARTITION_ID" />
    <result property="historyCleanupDate" column="HISTORY_CLEANUP_DATE" />
  </resultMap>

  <insert id="insert" parameterType="io.camunda.db.rdbms.write.domain.MessageCorrelationDbModel">
    INSERT INTO ${prefix}MESSAGE_CORRELATION (
      SUBSCRIPTION_KEY,
      MESSAGE_KEY,
      MESSAGE_NAME,
      CORRELATION_KEY,
      PROCESS_INSTANCE_KEY,
      FLOW_NODE_INSTANCE_KEY,
      FLOW_NODE_ID,
      BPMN_PROCESS_ID,
      PROCESS_DEFINITION_KEY,
      TENANT_ID,
      DATE_TIME,
      PARTITION_ID,
      HISTORY_CLEANUP_DATE
    ) VALUES (
      #{subscriptionKey},
      #{messageKey},
      #{messageName},
      #{correlationKey},
      #{processInstanceKey},
      #{flowNodeInstanceKey},
      #{flowNodeId},
      #{bpmnProcessId},
      #{processDefinitionKey},
      #{tenantId},
      #{dateTime},
      #{partitionId},
      #{historyCleanupDate}
    )
  </insert>

  <update id="update" parameterType="io.camunda.db.rdbms.write.domain.MessageCorrelationDbModel">
    UPDATE ${prefix}MESSAGE_CORRELATION SET
      MESSAGE_NAME = #{messageName},
      CORRELATION_KEY = #{correlationKey},
      PROCESS_INSTANCE_KEY = #{processInstanceKey},
      FLOW_NODE_INSTANCE_KEY = #{flowNodeInstanceKey},
      FLOW_NODE_ID = #{flowNodeId},
      BPMN_PROCESS_ID = #{bpmnProcessId},
      PROCESS_DEFINITION_KEY = #{processDefinitionKey},
      TENANT_ID = #{tenantId},
      DATE_TIME = #{dateTime},
      PARTITION_ID = #{partitionId},
      HISTORY_CLEANUP_DATE = #{historyCleanupDate}
    WHERE SUBSCRIPTION_KEY = #{subscriptionKey} AND MESSAGE_KEY = #{messageKey}
  </update>

  <update id="updateHistoryCleanupDate" parameterType="io.camunda.db.rdbms.sql.ProcessBasedHistoryCleanupMapper$UpdateHistoryCleanupDateDto">
    UPDATE ${prefix}MESSAGE_CORRELATION SET
      HISTORY_CLEANUP_DATE = #{historyCleanupDate}
    WHERE PROCESS_INSTANCE_KEY = #{processInstanceKey}
  </update>

  <delete id="cleanupHistory" parameterType="io.camunda.db.rdbms.sql.HistoryCleanupMapper$CleanupHistoryDto">
    DELETE FROM ${prefix}MESSAGE_CORRELATION
    WHERE PARTITION_ID = #{partitionId}
      AND HISTORY_CLEANUP_DATE &lt; #{cleanupDate}
    LIMIT #{limit}
  </delete>

</mapper>