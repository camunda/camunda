<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.camunda.db.rdbms.sql.BatchOperationMapper">

  <resultMap id="BatchOperationResultMap" type="io.camunda.search.entities.BatchOperationEntity">
    <constructor>
      <idArg column="BATCH_OPERATION_KEY" javaType="java.lang.Long"/>
      <arg column="OPERATION_TYPE" javaType="java.lang.String"/>
      <arg column="START_DATE" javaType="java.time.OffsetDateTime"/>
      <arg column="END_DATE" javaType="java.time.OffsetDateTime"/>
      <arg column="OPERATIONS_TOTAL_COUNT" javaType="java.lang.Integer"/>
      <arg column="OPERATIONS_FAILED_COUNT" javaType="java.lang.Integer"/>
      <arg column="OPERATIONS_COMPLETED_COUNT" javaType="java.lang.Integer"/>
    </constructor>
  </resultMap>

  <insert id="insert" parameterType="io.camunda.db.rdbms.write.domain.BatchOperationDbModel">
    INSERT INTO BATCH_OPERATION (BATCH_OPERATION_KEY,
                                 OPERATION_TYPE,
                                 START_DATE,
                                 END_DATE,
                                 OPERATIONS_TOTAL_COUNT,
                                 OPERATIONS_FAILED_COUNT,
                                 OPERATIONS_COMPLETED_COUNT)
    VALUES (#{batchOperationKey},
            #{operationType},
            #{startDate},
            #{endDate},
            #{operationsTotalCount},
            #{operationsFailedCount},
            #{operationsCompletedCount})
  </insert>

  <update id="updateCompleted"
    parameterType="io.camunda.db.rdbms.sql.BatchOperationMapper$BatchOperationUpdateDto">
    UPDATE BATCH_OPERATION
    SET END_DATE                   = #{endDate},
        OPERATIONS_FAILED_COUNT    = #{operationsFailedCount},
        OPERATIONS_COMPLETED_COUNT = #{operationsCompletedCount}
    WHERE BATCH_OPERATION_KEY = #{batchOperationKey}
  </update>

  <select id="count" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM BATCH_OPERATION
  </select>

  <select id="search" resultMap="BatchOperationResultMap">
    SELECT *
    FROM BATCH_OPERATION
  </select>

</mapper>
