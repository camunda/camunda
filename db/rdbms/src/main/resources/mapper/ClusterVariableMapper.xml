<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under
  ~ one or more contributor license agreements. See the NOTICE file distributed
  ~ with this work for additional information regarding copyright ownership.
  ~ Licensed under the Camunda License 1.0. You may not use this file
  ~ except in compliance with the Camunda License 1.0.
  -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.camunda.db.rdbms.sql.ClusterVariableMapper">

  <resultMap id="clusterVariableResultMap" type="io.camunda.search.entities.ClusterVariableEntity">
    <constructor>
      <idArg column="CLUSTER_VARIABLE_ID" javaType="java.lang.String"/>
      <arg column="VAR_NAME" javaType="java.lang.String"/>
      <arg column="VAR_VALUE" javaType="java.lang.String"/>
      <arg column="VAR_FULL_VALUE" javaType="java.lang.String"/>
      <arg column="IS_PREVIEW" javaType="boolean"/>
      <arg column="SCOPE" javaType="java.lang.String"/>
      <arg column="RESOURCE_ID" javaType="java.lang.String"/>
    </constructor>
  </resultMap>

  <select id="count" resultType="java.lang.Long">
    SELECT COUNT(*)
    FROM ${prefix}CLUSTER_VARIABLE
    <include refid="io.camunda.db.rdbms.sql.ClusterVariableMapper.searchFilter"/>
  </select>

  <select id="search" parameterType="io.camunda.db.rdbms.read.domain.ClusterVariableDbQuery"
    resultMap="io.camunda.db.rdbms.sql.ClusterVariableMapper.clusterVariableResultMap">
    SELECT * FROM (
    SELECT
    CLUSTER_VARIABLE_ID,
    VAR_NAME,
    VAR_VALUE,
    VAR_FULL_VALUE,
    RESOURCE_ID,
    SCOPE,
    IS_PREVIEW
    FROM ${prefix}CLUSTER_VARIABLE
    <include refid="io.camunda.db.rdbms.sql.ClusterVariableMapper.searchFilter"/>
    ) t
    <include refid="io.camunda.db.rdbms.sql.Commons.keySetPageFilter"/>
    <include refid="io.camunda.db.rdbms.sql.Commons.orderBy"/>
    <include refid="io.camunda.db.rdbms.sql.Commons.paging"/>
  </select>

  <insert id="insert" parameterType="io.camunda.db.rdbms.write.domain.ClusterVariableDbModel">
    INSERT INTO ${prefix}CLUSTER_VARIABLE (CLUSTER_VARIABLE_ID, VAR_NAME, TYPE, DOUBLE_VALUE,
                                           LONG_VALUE, VAR_VALUE, VAR_FULL_VALUE, IS_PREVIEW,
                                           RESOURCE_ID,
                                           SCOPE)
    VALUES (#{clusterVariableId}, #{name}, #{type}, #{doubleValue, jdbcType=DOUBLE},
            #{longValue, jdbcType=NUMERIC},
            #{value},
            #{fullValue}, #{isPreview}, #{resourceId}, #{scope})
  </insert>

  <delete id="delete" parameterType="io.camunda.db.rdbms.write.domain.ClusterVariableDbModel">
    DELETE
    FROM ${prefix}CLUSTER_VARIABLE
    WHERE CLUSTER_VARIABLE_ID = #{clusterVariableId}
  </delete>

  <sql id="searchFilter">
    <where>
      <!-- authorization filters -->
      <if test="authorizedResourceIds != null and !authorizedResourceIds.isEmpty()">
        AND RESOURCE_ID IN
        <foreach collection="authorizedResourceIds" item="resourceId" open="(" separator=","
          close=")">
          #{resourceId}
        </foreach>
      </if>

      <!-- basic filters -->
      <if test="filter.nameOperations != null and !filter.nameOperations.isEmpty()">
        <foreach collection="filter.nameOperations" item="operation">
          AND VAR_NAME
          <include refid="io.camunda.db.rdbms.sql.Commons.operationCondition"/>
        </foreach>
      </if>

      <if test="filter.scopeOperations != null and !filter.scopeOperations.isEmpty()">
        <foreach collection="filter.scopeOperations" item="operation">
          AND SCOPE
          <include refid="io.camunda.db.rdbms.sql.Commons.operationCondition"/>
        </foreach>
      </if>

      <if test="filter.resourceIdOperations != null and !filter.resourceIdOperations.isEmpty()">
        <foreach collection="filter.resourceIdOperations" item="operation">
          AND RESOURCE_ID
          <include refid="io.camunda.db.rdbms.sql.Commons.operationCondition"/>
        </foreach>
      </if>

      <!-- advanced filters on variable values -->
      <if test="filter.valueOperations != null and !filter.valueOperations.isEmpty()">
        <foreach collection="filter.valueOperations" item="operation">
          AND
          <include refid="io.camunda.db.rdbms.sql.Commons.variableOperationCondition"/>
        </foreach>
      </if>
    </where>
  </sql>


</mapper>

